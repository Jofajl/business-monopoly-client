<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Monopoly - T-Level Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        /* CSS Variables */
        :root {
            --black: #080808;
            --brown: #640303;
            --board: #fafaf8;
            --dark-purple: #5e3577;
            --light-blue: #d2eaf5;
            --purple: #b02f7c;
            --orange: #fa811d;
            --red: #f50c2b;
            --yellow: #ffed20;
            --green: #41994e;
            --dark-blue: #5a6dba;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            
            /* Scaling variables */
            --scale: 1;
            --board-size: 780px;
            --corner-size: 98px;
            --space-size: 63px;
            --container-height: 98px;
            --container-width: 63px;
        }

        /* Global Styles */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Oswald', sans-serif;
            font-weight: 400;
            font-size: 10px;
            color: var(--black);
            text-transform: uppercase;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body.dark-theme {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #ecf0f1;
        }

        body.high-contrast {
            background: #000000;
            color: #ffffff;
        }

        h1, h2, h3, h4, h5, h6 {
            margin: 0;
        }

        /* Accessibility Controls */
        .accessibility-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 2000;
            display: flex;
            gap: 10px;
        }

        .accessibility-btn {
            padding: 6px 9px;
            border: none;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            cursor: pointer;
            font-size: 9px;
            transition: all 0.3s ease;
        }

        .accessibility-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
        }

        .accessibility-btn.active {
            background: var(--success);
            color: white;
        }

        /* Property Colors */
        .dark-purple { background: var(--dark-purple); }
        .light-blue { background: var(--light-blue); }
        .purple { background: var(--purple); }
        .orange { background: var(--orange); }
        .red { background: var(--red); }
        .yellow { background: var(--yellow); }
        .green { background: var(--green); }
        .dark-blue { background: var(--dark-blue); }

        /* Game Container */
        .game-container {
            max-width: 1100px;
            width: 100%;
            display: flex;
            gap: 15px;
            padding: 15px;
            min-height: 100vh;
            align-items: flex-start;
        }

        .game-container.single-column {
            flex-direction: column;
            align-items: center;
        }

        /* Board Layout */
        .table {
            padding: calc(12px * var(--scale));
        }

        .board {
            display: grid;
            grid-template-columns: var(--corner-size) repeat(9, var(--space-size)) var(--corner-size);
            grid-template-rows: var(--corner-size) repeat(9, var(--space-size)) var(--corner-size);
            grid-gap: calc(2px * var(--scale));
            width: var(--board-size);
            height: var(--board-size);
            background: var(--black);
            border: calc(2px * var(--scale)) solid var(--black);
            border-radius: calc(8px * var(--scale));
            box-shadow: 0 calc(16px * var(--scale)) calc(47px * var(--scale)) rgba(0,0,0,0.3);
        }

        /* Center Area */
        .center {
            grid-column: 2 / 11;
            grid-row: 2 / 11;
            background: var(--board);
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(9, 1fr);
            justify-items: center;
            align-items: center;
            border-radius: calc(6px * var(--scale));
            padding: calc(16px * var(--scale));
        }

        .title {
            grid-column: 1 / 8;
            grid-row: 2 / 3;
            font-size: calc(38px * var(--scale));
            font-weight: 600;
            letter-spacing: calc(6px * var(--scale));
            color: var(--red);
            text-align: center;
        }

        .business-subtitle {
            grid-column: 1 / 8;
            grid-row: 3 / 4;
            font-size: calc(13px * var(--scale));
            font-weight: 400;
            letter-spacing: calc(2px * var(--scale));
            color: var(--black);
            text-align: center;
        }

        .turn-indicator {
            grid-column: 1 / 8;
            grid-row: 4 / 5;
            background: #4CAF50;
            color: white;
            padding: calc(12px * var(--scale)) calc(24px * var(--scale));
            border-radius: calc(20px * var(--scale));
            font-weight: bold;
            text-align: center;
            font-size: calc(11px * var(--scale));
            letter-spacing: calc(1px * var(--scale));
        }

        .center-controls {
            grid-column: 1 / 8;
            grid-row: 5 / 8;
            display: flex;
            flex-direction: column;
            gap: calc(8px * var(--scale));
            width: 100%;
            max-width: calc(235px * var(--scale));
        }

        .center-controls .btn {
            padding: calc(12px * var(--scale)) calc(20px * var(--scale));
            font-size: calc(11px * var(--scale));
            border-radius: calc(9px * var(--scale));
            box-shadow: 0 calc(3px * var(--scale)) calc(9px * var(--scale)) rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .center-controls .btn:hover {
            transform: translateY(calc(-2px * var(--scale)));
            box-shadow: 0 calc(5px * var(--scale)) calc(16px * var(--scale)) rgba(0,0,0,0.3);
        }

        .center-dice-result {
            grid-column: 1 / 8;
            grid-row: 8 / 9;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: calc(8px * var(--scale)) 0;
            padding: calc(12px * var(--scale));
            background: rgba(255, 255, 255, 0.9);
            border-radius: calc(9px * var(--scale));
            border: calc(2px * var(--scale)) solid #ddd;
            min-height: calc(63px * var(--scale));
        }

        /* Rows of spaces */
        .row {
            display: grid;
            grid-gap: calc(2px * var(--scale));
        }

        .horizontal-row {
            grid-template-columns: repeat(9, calc(80px * var(--scale)));
            grid-template-rows: calc(125px * var(--scale));
        }

        .vertical-row {
            grid-template-columns: calc(125px * var(--scale));
            grid-template-rows: repeat(9, calc(80px * var(--scale)));
        }

        .vertical-row .container {
            top: 50%;
            left: 50%;
        }

        .bottom-row {
            grid-column: 2 / 11;
            grid-row: 11;
        }

        .left-row {
            grid-column: 1;
            grid-row: 2 / 11;
        }

        .left-row .container {
            transform: translate(-50%, -50%) rotate(90deg);
        }

        .top-row {
            grid-column: 2 / 11;
            grid-row: 1;
        }

        .top-row .container {
            transform: rotate(180deg);
        }

        .right-row {
            grid-column: 11;
            grid-row: 2 / 11;
        }

        .right-row .container {
            transform: translate(-50%, -50%) rotate(270deg);
        }

        /* Spaces */
        .space {
            background: var(--board);
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .space:hover {
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 calc(5px * var(--scale)) calc(15px * var(--scale)) rgba(0,0,0,0.3);
        }

        .space.owned {
            border: calc(3px * var(--scale)) solid var(--success);
        }

        .space.developed {
            background: linear-gradient(45deg, var(--board) 70%, var(--success) 30%);
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            transform-origin: center;
            height: var(--container-height);
            width: var(--container-width);
            padding: calc(4px * var(--scale));
        }

        .name,
        .instructions {
            padding-left: calc(6px * var(--scale));
            padding-right: calc(6px * var(--scale));
            font-size: calc(7px * var(--scale));
            line-height: 1.0;
        }

        .price {
            font-size: calc(5px * var(--scale));
            font-weight: 400;
            padding-bottom: calc(4px * var(--scale));
        }

        /* Property Development Indicators */
        .development-indicator {
            position: absolute;
            bottom: calc(4px * var(--scale));
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: calc(1px * var(--scale));
        }

        .development-house {
            width: calc(6px * var(--scale));
            height: calc(6px * var(--scale));
            background: var(--success);
            border-radius: calc(1px * var(--scale));
        }

        .development-hotel {
            width: calc(9px * var(--scale));
            height: calc(6px * var(--scale));
            background: var(--red);
            border-radius: calc(1px * var(--scale));
        }

        /* Corner Spaces */
        .corner .container {
            justify-content: space-around;
            height: 100%;
            width: 100%;
        }

        .corner .name {
            padding: 0;
            font-size: calc(9px * var(--scale));
            font-weight: 600;
        }

        /* Property Spaces */
        .property .color-bar {
            height: calc(20px * var(--scale));
            border-bottom: calc(2px * var(--scale)) solid var(--black);
        }

        .property .name {
            padding-bottom: calc(31px * var(--scale));
            font-weight: 500;
        }

        /* Specific Corners */
        .go {
            grid-column: 11;
            grid-row: 11;
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            border-radius: 0 0 calc(10px * var(--scale)) 0;
        }

        .go .container {
            justify-content: center;
            transform: rotate(315deg);
        }

        .go .go-word {
            font-size: calc(28px * var(--scale));
            color: white;
            font-weight: 600;
        }

        .jail {
            grid-column: 1;
            grid-row: 11;
            background: linear-gradient(45deg, #ffa500, #ffb84d);
            border-radius: 0 0 0 calc(10px * var(--scale));
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .jail .name {
            font-size: calc(13px * var(--scale));
            font-weight: 600;
            color: white;
        }

        .free-parking {
            grid-column: 1;
            grid-row: 1;
            background: linear-gradient(45deg, #4ecdc4, #6ed0ca);
            border-radius: calc(10px * var(--scale)) 0 0 0;
        }

        .free-parking .container {
            justify-content: center;
            transform: rotate(135deg);
        }

        .free-parking .name {
            font-size: calc(11px * var(--scale));
            color: white;
            font-weight: 600;
        }

        .go-to-jail {
            grid-column: 11;
            grid-row: 1;
            background: linear-gradient(45deg, #ff4757, #ff6b7a);
            border-radius: 0 calc(10px * var(--scale)) 0 0;
        }

        .go-to-jail .container {
            justify-content: center;
            transform: rotate(225deg);
        }

        .go-to-jail .name {
            font-size: calc(9px * var(--scale));
            color: white;
            font-weight: 600;
        }

        /* Special Spaces */
        .chance .container,
        .community-chest .container {
            justify-content: center;
        }

        .chance .drawing {
            font-size: calc(31px * var(--scale));
            color: var(--red);
        }

        .community-chest .drawing {
            font-size: calc(24px * var(--scale));
            color: var(--light-blue);
        }

        .railroad .drawing,
        .utility .drawing {
            font-size: calc(24px * var(--scale));
            color: var(--black);
        }

        /* Player Pieces */
        .player-piece {
            position: absolute;
            width: calc(24px * var(--scale));
            height: calc(24px * var(--scale));
            border-radius: 50%;
            border: calc(2px * var(--scale)) solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: calc(9px * var(--scale));
            color: white;
            z-index: 100;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 calc(3px * var(--scale)) calc(9px * var(--scale)) rgba(0,0,0,0.4);
            cursor: pointer;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .player-piece:hover {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 calc(5px * var(--scale)) calc(16px * var(--scale)) rgba(0,0,0,0.5);
        }

        .player-piece.moving {
            animation: bounce 0.5s ease-in-out;
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 calc(6px * var(--scale)) calc(20px * var(--scale)) rgba(0,0,0,0.6);
        }

        @keyframes bounce {
            0%, 100% { transform: translate(-50%, -50%) scale(1.2); }
            50% { transform: translate(-50%, -50%) scale(1.4); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .player-piece-0 { background: #ff6b6b; }
        .player-piece-1 { background: #4ecdc4; }
        .player-piece-2 { background: #45b7d1; }
        .player-piece-3 { background: #f39c12; }
        .player-piece-4 { background: #9b59b6; }
        .player-piece-5 { background: #e74c3c; }

        /* Game Panel */
        .game-panel {
            width: calc(275px * var(--scale));
            background: white;
            border-radius: calc(12px * var(--scale));
            padding: calc(16px * var(--scale));
            box-shadow: 0 calc(8px * var(--scale)) calc(24px * var(--scale)) rgba(0,0,0,0.2);
            max-height: var(--board-size);
            overflow-y: auto;
        }

        /* Dice */
        .dice {
            width: calc(47px * var(--scale));
            height: calc(47px * var(--scale));
            background: white;
            border: calc(2px * var(--scale)) solid var(--black);
            border-radius: calc(9px * var(--scale));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(22px * var(--scale));
            font-weight: bold;
            box-shadow: 0 calc(3px * var(--scale)) calc(9px * var(--scale)) rgba(0,0,0,0.3);
            position: relative;
            margin: 0 calc(4px * var(--scale));
            transition: all 0.3s ease;
        }

        .dice-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: calc(12px * var(--scale));
            margin: calc(12px * var(--scale)) 0;
            flex-wrap: wrap;
        }

        .dice-total {
            font-size: calc(13px * var(--scale));
            font-weight: bold;
            color: var(--red);
            margin: calc(8px * var(--scale)) 0;
            padding: calc(6px * var(--scale)) calc(13px * var(--scale));
            background: #f8f9fa;
            border-radius: calc(16px * var(--scale));
            border: calc(2px * var(--scale)) solid var(--red);
        }

        .panel-section {
            margin-bottom: calc(20px * var(--scale));
            padding: calc(15px * var(--scale));
            border-radius: calc(10px * var(--scale));
            background: #f8f9fa;
        }

        .panel-section h3 {
            margin-bottom: calc(15px * var(--scale));
            color: #2c5f2d;
            border-bottom: calc(2px * var(--scale)) solid #4CAF50;
            padding-bottom: calc(5px * var(--scale));
            font-size: calc(16px * var(--scale));
        }

        .players-list {
            display: flex;
            flex-direction: column;
            gap: calc(10px * var(--scale));
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: calc(12px * var(--scale));
            background: white;
            border-radius: calc(8px * var(--scale));
            border-left: calc(4px * var(--scale)) solid #4CAF50;
            font-size: calc(12px * var(--scale));
        }

        .player-item.current {
            border-left-color: #ff6b6b;
            background: #fff5f5;
        }

        .player-money {
            font-weight: bold;
            color: #27ae60;
        }

        .player-achievements {
            display: flex;
            gap: calc(5px * var(--scale));
            margin-top: calc(5px * var(--scale));
        }

        .achievement-badge {
            width: calc(16px * var(--scale));
            height: calc(16px * var(--scale));
            border-radius: 50%;
            background: #ffd700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(8px * var(--scale));
            color: #333;
        }

        .game-controls {
            display: flex;
            flex-direction: column;
            gap: calc(10px * var(--scale));
        }

        .btn {
            padding: calc(12px * var(--scale)) calc(20px * var(--scale));
            border: none;
            border-radius: calc(8px * var(--scale));
            font-size: calc(12px * var(--scale));
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: calc(1px * var(--scale));
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::after {
            width: calc(300px * var(--scale));
            height: calc(300px * var(--scale));
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(calc(-2px * var(--scale)));
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .dice-result {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: calc(15px * var(--scale)) 0;
            padding: calc(15px * var(--scale));
            background: #f8f9fa;
            border-radius: calc(12px * var(--scale));
            border: calc(2px * var(--scale)) solid #ddd;
        }

        /* Achievement System */
        .achievement-popup {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: calc(20px * var(--scale));
            border-radius: calc(15px * var(--scale));
            box-shadow: 0 calc(10px * var(--scale)) calc(30px * var(--scale)) rgba(255, 215, 0, 0.3);
            z-index: 1500;
            max-width: calc(300px * var(--scale));
            animation: achievementSlide 0.5s ease-out;
        }

        @keyframes achievementSlide {
            from {
                right: calc(-320px * var(--scale));
                opacity: 0;
            }
            to {
                right: 20px;
                opacity: 1;
            }
        }

        .achievement-icon {
            font-size: calc(48px * var(--scale));
            text-align: center;
            margin-bottom: calc(10px * var(--scale));
        }

        .achievement-title {
            font-size: calc(18px * var(--scale));
            font-weight: bold;
            text-align: center;
            margin-bottom: calc(5px * var(--scale));
        }

        .achievement-description {
            font-size: calc(14px * var(--scale));
            text-align: center;
            text-transform: none;
        }

        /* Learning Analytics */
        .learning-analytics {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: calc(10px * var(--scale));
            padding: calc(15px * var(--scale));
            margin-bottom: calc(15px * var(--scale));
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: calc(10px * var(--scale));
            font-size: calc(11px * var(--scale));
        }

        .analytics-item {
            text-align: center;
            padding: calc(8px * var(--scale));
            background: rgba(255, 255, 255, 0.1);
            border-radius: calc(5px * var(--scale));
        }

        .analytics-value {
            font-size: calc(18px * var(--scale));
            font-weight: bold;
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: calc(8px * var(--scale));
            background: rgba(255, 255, 255, 0.2);
            border-radius: calc(4px * var(--scale));
            overflow: hidden;
            margin-top: calc(10px * var(--scale));
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s ease;
        }

        /* Property Purchase Modal */
        .property-purchase-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .property-purchase-card {
            background: white;
            border-radius: calc(20px * var(--scale));
            padding: calc(30px * var(--scale));
            max-width: calc(450px * var(--scale));
            width: 90%;
            text-align: center;
            box-shadow: 0 calc(20px * var(--scale)) calc(60px * var(--scale)) rgba(0,0,0,0.4);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .property-purchase-card.show {
            transform: scale(1);
            opacity: 1;
        }

        .property-purchase-header {
            margin-bottom: calc(25px * var(--scale));
        }

        .property-purchase-title {
            font-size: calc(28px * var(--scale));
            font-weight: bold;
            margin-bottom: calc(10px * var(--scale));
            color: #333;
        }

        .property-color-band {
            height: calc(8px * var(--scale));
            width: 100%;
            border-radius: calc(4px * var(--scale));
            margin: calc(15px * var(--scale)) 0;
        }

        .property-color-band.dark-purple { background: var(--dark-purple); }
        .property-color-band.light-blue { background: var(--light-blue); }
        .property-color-band.purple { background: var(--purple); }
        .property-color-band.orange { background: var(--orange); }
        .property-color-band.red { background: var(--red); }
        .property-color-band.yellow { background: var(--yellow); }
        .property-color-band.green { background: var(--green); }
        .property-color-band.dark-blue { background: var(--dark-blue); }
        .property-color-band.railroad { background: var(--black); }
        .property-color-band.utility { background: #666; }

        .property-purchase-price {
            font-size: calc(24px * var(--scale));
            color: var(--success);
            font-weight: bold;
            margin: calc(20px * var(--scale)) 0;
        }

        .property-purchase-rent {
            background: #f8f9fa;
            padding: calc(15px * var(--scale));
            border-radius: calc(10px * var(--scale));
            margin: calc(20px * var(--scale)) 0;
            text-align: left;
        }

        .property-rent-title {
            font-weight: bold;
            margin-bottom: calc(8px * var(--scale));
            text-align: center;
            color: #333;
        }

        .property-rent-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: calc(5px * var(--scale));
            font-size: calc(14px * var(--scale));
            text-transform: none;
        }

        .property-purchase-actions {
            display: flex;
            gap: calc(15px * var(--scale));
            margin-top: calc(25px * var(--scale));
        }

        .property-purchase-actions .btn {
            flex: 1;
            padding: calc(15px * var(--scale)) calc(25px * var(--scale));
            font-size: calc(16px * var(--scale));
            font-weight: bold;
            border-radius: calc(12px * var(--scale));
            transition: all 0.3s ease;
        }

        .property-purchase-actions .btn:hover {
            transform: translateY(calc(-2px * var(--scale)));
            box-shadow: 0 calc(8px * var(--scale)) calc(25px * var(--scale)) rgba(0,0,0,0.2);
        }

        /* Property Cards */
        .property-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            border-radius: calc(15px * var(--scale));
            padding: calc(25px * var(--scale));
            box-shadow: 0 calc(20px * var(--scale)) calc(60px * var(--scale)) rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: calc(400px * var(--scale));
            width: 90%;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .property-card.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: calc(20px * var(--scale));
        }

        .property-title {
            font-size: calc(20px * var(--scale));
            font-weight: bold;
            color: #333;
        }

        .property-close {
            background: none;
            border: none;
            font-size: calc(24px * var(--scale));
            cursor: pointer;
            color: #999;
        }

        .rent-structure {
            background: #f8f9fa;
            padding: calc(15px * var(--scale));
            border-radius: calc(8px * var(--scale));
            margin-bottom: calc(15px * var(--scale));
        }

        .rent-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: calc(8px * var(--scale));
            font-size: calc(12px * var(--scale));
            text-transform: none;
        }

        .property-actions {
            display: flex;
            gap: calc(10px * var(--scale));
            margin-top: calc(20px * var(--scale));
        }

        /* Trading System */
        .trade-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1200;
        }

        .trade-content {
            background: white;
            border-radius: calc(15px * var(--scale));
            padding: calc(30px * var(--scale));
            max-width: calc(600px * var(--scale));
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .trade-section {
            margin-bottom: calc(20px * var(--scale));
            padding: calc(15px * var(--scale));
            border: calc(2px * var(--scale)) solid #ddd;
            border-radius: calc(10px * var(--scale));
        }

        .trade-section h4 {
            margin-bottom: calc(10px * var(--scale));
            color: #333;
        }

        .trade-items {
            display: flex;
            flex-wrap: wrap;
            gap: calc(10px * var(--scale));
        }

        .trade-item {
            padding: calc(8px * var(--scale)) calc(12px * var(--scale));
            background: #f8f9fa;
            border: calc(2px * var(--scale)) solid transparent;
            border-radius: calc(5px * var(--scale));
            cursor: pointer;
            font-size: calc(11px * var(--scale));
            text-transform: none;
            transition: all 0.3s ease;
        }

        .trade-item.selected {
            border-color: var(--success);
            background: #e8f5e8;
        }

        .property-group {
            margin-bottom: calc(15px * var(--scale));
        }

        .property-group-title {
            font-size: calc(12px * var(--scale));
            font-weight: bold;
            color: #333;
            margin-bottom: calc(8px * var(--scale));
            text-transform: uppercase;
            border-bottom: calc(1px * var(--scale)) solid #ddd;
            padding-bottom: calc(3px * var(--scale));
        }

        .property-list-item {
            padding: calc(8px * var(--scale));
            margin: calc(5px * var(--scale)) 0;
            border-radius: calc(6px * var(--scale));
            font-size: calc(11px * var(--scale));
            text-transform: none;
            border-left: calc(6px * var(--scale)) solid;
            background: white;
            box-shadow: 0 calc(2px * var(--scale)) calc(4px * var(--scale)) rgba(0,0,0,0.1);
        }

        .property-list-item.dark-purple { border-left-color: var(--dark-purple); }
        .property-list-item.light-blue { border-left-color: var(--light-blue); }
        .property-list-item.purple { border-left-color: var(--purple); }
        .property-list-item.orange { border-left-color: var(--orange); }
        .property-list-item.red { border-left-color: var(--red); }
        .property-list-item.yellow { border-left-color: var(--yellow); }
        .property-list-item.green { border-left-color: var(--green); }
        .property-list-item.dark-blue { border-left-color: var(--dark-blue); }
        .property-list-item.railroad { border-left-color: var(--black); }
        .property-list-item.utility { border-left-color: #666; }

        .property-list-item.developable {
            background: #e8f5e8;
        }

        .property-name {
            font-weight: bold;
            margin-bottom: calc(3px * var(--scale));
        }

        .property-details {
            font-size: calc(9px * var(--scale));
            color: #666;
        }

        .card-item {
            padding: calc(8px * var(--scale));
            margin: calc(5px * var(--scale)) 0;
            background: #fff3cd;
            border: calc(1px * var(--scale)) solid #ffeaa7;
            border-radius: calc(6px * var(--scale));
            font-size: calc(11px * var(--scale));
            text-transform: none;
            border-left: calc(4px * var(--scale)) solid #f39c12;
        }

        .card-item.chance {
            background: #ffeef0;
            border-color: #ffccd5;
            border-left-color: var(--red);
        }

        .card-item.community {
            background: #e8f4fd;
            border-color: #b3d9ff;
            border-left-color: var(--light-blue);
        }

        /* Special Space Animation */
        .space.special-landed {
            animation: specialGlow 2s ease-in-out;
        }

        @keyframes specialGlow {
            0%, 100% { box-shadow: none; }
            50% { box-shadow: 0 0 calc(30px * var(--scale)) #ffd700; }
        }

        .dice.rolling {
            animation: diceRoll 2s ease-in-out;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border-color: var(--red);
        }

        @keyframes diceRoll {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            25% { transform: rotateX(90deg) rotateY(180deg); }
            50% { transform: rotateX(180deg) rotateY(360deg); }
            75% { transform: rotateX(270deg) rotateY(180deg); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }

        /* Question Modal */
        .question-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .question-content {
            background: white;
            padding: calc(30px * var(--scale));
            border-radius: calc(15px * var(--scale));
            max-width: calc(600px * var(--scale));
            width: 90%;
            text-align: center;
            box-shadow: 0 calc(20px * var(--scale)) calc(60px * var(--scale)) rgba(0,0,0,0.3);
        }

        .question-content.bonus-chance {
            background: linear-gradient(135deg, #fff5f5, #ffe8e8);
            border: calc(3px * var(--scale)) solid var(--red);
        }

        .question-content.bonus-community {
            background: linear-gradient(135deg, #f0f8ff, #e8f4fd);
            border: calc(3px * var(--scale)) solid var(--light-blue);
        }

        .question-title {
            color: var(--red);
            margin-bottom: calc(20px * var(--scale));
            font-size: calc(24px * var(--scale));
            font-weight: 600;
        }

        .difficulty-indicator {
            display: inline-block;
            padding: calc(4px * var(--scale)) calc(8px * var(--scale));
            border-radius: calc(12px * var(--scale));
            font-size: calc(9px * var(--scale));
            margin-bottom: calc(12px * var(--scale));
        }

        .difficulty-easy {
            background: #d4edda;
            color: #155724;
        }

        .difficulty-medium {
            background: #fff3cd;
            color: #856404;
        }

        .difficulty-hard {
            background: #f8d7da;
            color: #721c24;
        }

        .bonus-reward {
            background: #d4edda;
            color: #155724;
            padding: calc(8px * var(--scale));
            border-radius: calc(6px * var(--scale));
            margin-bottom: calc(16px * var(--scale));
            font-weight: bold;
            border: calc(2px * var(--scale)) solid #c3e6cb;
        }

        .question-text {
            font-size: calc(16px * var(--scale));
            margin-bottom: calc(25px * var(--scale));
            line-height: 1.6;
            text-transform: none;
            color: #333;
        }

        .question-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: calc(15px * var(--scale));
            margin-bottom: calc(20px * var(--scale));
        }

        .question-option {
            padding: calc(15px * var(--scale));
            border: calc(2px * var(--scale)) solid #ddd;
            border-radius: calc(10px * var(--scale));
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            text-transform: none;
            font-size: calc(14px * var(--scale));
        }

        .question-option:hover {
            border-color: #4CAF50;
            background: #e8f5e8;
            transform: translateY(calc(-2px * var(--scale)));
        }

        .timer {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: calc(16px * var(--scale));
        }

        .timer-circle {
            width: calc(47px * var(--scale));
            height: calc(47px * var(--scale));
            border-radius: 50%;
            border: calc(3px * var(--scale)) solid #ddd;
            border-top: calc(3px * var(--scale)) solid #4CAF50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: calc(14px * var(--scale));
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Card Modal */
        .card-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .card-content {
            background: white;
            padding: calc(30px * var(--scale));
            border-radius: calc(15px * var(--scale));
            max-width: calc(500px * var(--scale));
            width: 90%;
            text-align: center;
            box-shadow: 0 calc(20px * var(--scale)) calc(60px * var(--scale)) rgba(0,0,0,0.3);
        }

        .card-content.chance {
            background: linear-gradient(135deg, #fff5f5, #ffe8e8);
            border: calc(3px * var(--scale)) solid var(--red);
        }

        .card-content.community {
            background: linear-gradient(135deg, #f0f8ff, #e8f4fd);
            border: calc(3px * var(--scale)) solid var(--light-blue);
        }

        .card-title {
            font-size: calc(28px * var(--scale));
            margin-bottom: calc(20px * var(--scale));
            font-weight: 600;
        }

        .card-text {
            font-size: calc(18px * var(--scale));
            line-height: 1.6;
            text-transform: none;
            color: #333;
            margin-bottom: calc(20px * var(--scale));
        }

        /* Room Setup */
        .room-setup {
            text-align: center;
            background: white;
            padding: calc(40px * var(--scale));
            border-radius: calc(15px * var(--scale));
            box-shadow: 0 calc(10px * var(--scale)) calc(30px * var(--scale)) rgba(0,0,0,0.2);
            max-width: calc(400px * var(--scale));
            margin: 0 auto;
        }

        .room-setup h1 {
            color: #2c5f2d;
            margin-bottom: calc(30px * var(--scale));
            font-size: calc(28px * var(--scale));
        }

        .input-group {
            margin-bottom: calc(20px * var(--scale));
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: calc(5px * var(--scale));
            font-weight: bold;
            color: #333;
            text-transform: none;
        }

        .input-group input {
            width: 100%;
            padding: calc(12px * var(--scale));
            border: calc(2px * var(--scale)) solid #ddd;
            border-radius: calc(8px * var(--scale));
            font-size: calc(16px * var(--scale));
        }

        .input-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .room-actions {
            display: flex;
            gap: calc(10px * var(--scale));
        }

        .room-code-display {
            background: #f8f9fa;
            padding: calc(20px * var(--scale));
            border-radius: calc(10px * var(--scale));
            margin-bottom: calc(20px * var(--scale));
        }

        .room-code {
            font-size: calc(24px * var(--scale));
            font-weight: bold;
            color: #2c5f2d;
            letter-spacing: calc(2px * var(--scale));
        }

        .hidden {
            display: none !important;
        }

        /* Sound Controls */
        .sound-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1500;
        }

        .sound-btn {
            width: calc(39px * var(--scale));
            height: calc(39px * var(--scale));
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: calc(16px * var(--scale));
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 calc(3px * var(--scale)) calc(9px * var(--scale)) rgba(0,0,0,0.2);
        }

        .sound-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .sound-btn.muted {
            background: #dc3545;
            color: white;
        }

        /* Responsive Design with Proper Scaling */
        @media (max-width: 1200px) {
            :root {
                --scale: 0.8;
                --board-size: 624px;
                --corner-size: 78px;
                --space-size: 50px;
                --container-height: 78px;
                --container-width: 50px;
            }
            
            .game-container {
                flex-direction: column;
                align-items: center;
            }
            
            .game-panel {
                width: 100%;
                max-width: var(--board-size);
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            :root {
                --scale: 0.6;
                --board-size: 468px;
                --corner-size: 59px;
                --space-size: 37px;
                --container-height: 59px;
                --container-width: 37px;
            }

            .game-container {
                padding: calc(10px * var(--scale));
                gap: calc(10px * var(--scale));
            }

            .game-panel {
                width: 100%;
                max-width: var(--board-size);
            }

            .property-purchase-card,
            .question-content,
            .card-content,
            .property-card {
                width: 95%;
                margin: 0 auto;
            }
        }

        @media (max-width: 480px) {
            :root {
                --scale: 0.5;
                --board-size: 390px;
                --corner-size: 49px;
                --space-size: 31px;
                --container-height: 49px;
                --container-width: 31px;
            }

            .question-options {
                grid-template-columns: 1fr;
            }

            .property-purchase-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Accessibility Controls -->
    <div class="accessibility-controls">
        <button class="accessibility-btn" onclick="toggleTheme()" title="Toggle Dark Theme">🌙</button>
        <button class="accessibility-btn" onclick="toggleHighContrast()" title="High Contrast">🔆</button>
        <button class="accessibility-btn" onclick="adjustFontSize()" title="Increase Font Size">🔍</button>
    </div>

    <!-- Sound Controls -->
    <div class="sound-controls">
        <button class="sound-btn" onclick="toggleSound()" title="Toggle Sound">🔊</button>
    </div>

    <div id="room-setup" class="room-setup">
        <h1>🎓 Business Monopoly</h1>
        <p style="margin-bottom: 30px; color: #666; text-transform: none;">T-Level Business Education Game</p>
        
        <div class="input-group">
            <label for="playerName">Your Name:</label>
            <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
        </div>
        
        <div class="room-actions">
            <button class="btn btn-primary" onclick="gameController.createRoom()">Create Room</button>
            <button class="btn btn-secondary" onclick="gameController.showJoinForm()">Join Room</button>
        </div>
        
        <div id="join-form" class="hidden" style="margin-top: 20px;">
            <div class="input-group">
                <label for="roomCode">Room Code:</label>
                <input type="text" id="roomCode" placeholder="Enter room code" maxlength="6">
            </div>
            <button class="btn btn-primary" onclick="gameController.joinRoom()">Join Game</button>
        </div>
        
        <div id="room-created" class="hidden">
            <div class="room-code-display">
                <p style="text-transform: none;">Share this code with other players:</p>
                <div id="room-code" class="room-code"></div>
            </div>
            <div id="waiting-players"></div>
            <button id="start-game-btn" class="btn btn-primary hidden" onclick="gameController.startGame()">Start Game</button>
        </div>
    </div>

    <div id="game-container" class="game-container hidden">
        <div class="table">
            <div class="board">
                <!-- Center -->
                <div class="center">
                    <div class="title">BUSINESS</div>
                    <div class="business-subtitle">MONOPOLY</div>
                    <div id="turn-indicator" class="turn-indicator">Waiting to start...</div>
                    
                    <!-- Game Controls in Center -->
                    <div id="center-game-controls" class="center-controls">
                        <button id="start-turn-btn" class="btn btn-primary" onclick="gameController.startTurn()">Start Turn</button>
                        <button id="roll-dice-btn" class="btn btn-primary hidden" onclick="gameController.rollDice()">Roll Dice</button>
                        <button id="buy-property-btn" class="btn btn-secondary hidden" onclick="gameController.buyProperty()">Buy Property</button>
                        <button id="develop-property-btn" class="btn btn-warning hidden" onclick="gameController.showDevelopmentOptions()">Develop Properties</button>
                        <button id="end-turn-btn" class="btn btn-danger hidden" onclick="gameController.endTurn()">End Turn</button>
                    </div>
                    
                    <!-- Dice Result in Center -->
                    <div id="center-dice-result" class="center-dice-result hidden"></div>
                </div>

                <!-- Corner: GO -->
                <div class="space corner go" data-index="0" onclick="showPropertyInfo(0)">
                    <div class="container">
                        <div class="name">Collect £200</div>
                        <div class="go-word">GO</div>
                    </div>
                </div>

                <!-- Bottom Row (Moving LEFT from GO) -->
                <div class="row horizontal-row bottom-row">
                    <div class="space property" data-index="9" onclick="showPropertyInfo(9)">
                        <div class="container">
                            <div class="color-bar light-blue"></div>
                            <div class="name">Pentonville</div>
                            <div class="price">£120</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space property" data-index="8" onclick="showPropertyInfo(8)">
                        <div class="container">
                            <div class="color-bar light-blue"></div>
                            <div class="name">Euston Road</div>
                            <div class="price">£100</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space chance" data-index="7">
                        <div class="container">
                            <div class="name">Chance</div>
                            <i class="drawing fa fa-question"></i>
                        </div>
                    </div>
                    <div class="space property" data-index="6" onclick="showPropertyInfo(6)">
                        <div class="container">
                            <div class="color-bar light-blue"></div>
                            <div class="name">Angel</div>
                            <div class="price">£100</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space railroad" data-index="5" onclick="showPropertyInfo(5)">
                        <div class="container">
                            <div class="name">King's Cross</div>
                            <i class="drawing fa fa-subway"></i>
                            <div class="price">£200</div>
                        </div>
                    </div>
                    <div class="space fee" data-index="4">
                        <div class="container">
                            <div class="name">Income Tax</div>
                            <div class="instructions">Pay £200</div>
                        </div>
                    </div>
                    <div class="space property" data-index="3" onclick="showPropertyInfo(3)">
                        <div class="container">
                            <div class="color-bar dark-purple"></div>
                            <div class="name">Whitechapel</div>
                            <div class="price">£60</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space community-chest" data-index="2">
                        <div class="container">
                            <div class="name">Community</div>
                            <i class="drawing fa fa-cube"></i>
                        </div>
                    </div>
                    <div class="space property" data-index="1" onclick="showPropertyInfo(1)">
                        <div class="container">
                            <div class="color-bar dark-purple"></div>
                            <div class="name">Old Kent Rd</div>
                            <div class="price">£60</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                </div>

                <!-- Corner: Jail -->
                <div class="space corner jail" data-index="10">
                    <div class="name">Jail</div>
                </div>

                <!-- Left Row (Moving UP from Jail to Free Parking) -->
                <div class="row vertical-row left-row">
                    <div class="space property" data-index="19" onclick="showPropertyInfo(19)">
                        <div class="container">
                            <div class="color-bar orange"></div>
                            <div class="name">Vine Street</div>
                            <div class="price">£200</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space property" data-index="18" onclick="showPropertyInfo(18)">
                        <div class="container">
                            <div class="color-bar orange"></div>
                            <div class="name">Marlborough</div>
                            <div class="price">£180</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space community-chest" data-index="17">
                        <div class="container">
                            <div class="name">Community</div>
                            <i class="drawing fa fa-cube"></i>
                        </div>
                    </div>
                    <div class="space property" data-index="16" onclick="showPropertyInfo(16)">
                        <div class="container">
                            <div class="color-bar orange"></div>
                            <div class="name">Bow Street</div>
                            <div class="price">£180</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space railroad" data-index="15" onclick="showPropertyInfo(15)">
                        <div class="container">
                            <div class="name">Marylebone</div>
                            <i class="drawing fa fa-subway"></i>
                            <div class="price">£200</div>
                        </div>
                    </div>
                    <div class="space property" data-index="14" onclick="showPropertyInfo(14)">
                        <div class="container">
                            <div class="color-bar purple"></div>
                            <div class="name">Northumberland</div>
                            <div class="price">£160</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space property" data-index="13" onclick="showPropertyInfo(13)">
                        <div class="container">
                            <div class="color-bar purple"></div>
                            <div class="name">Whitehall</div>
                            <div class="price">£140</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space utility" data-index="12" onclick="showPropertyInfo(12)">
                        <div class="container">
                            <div class="name">Electric Co</div>
                            <i class="drawing fa fa-lightbulb-o"></i>
                            <div class="price">£150</div>
                        </div>
                    </div>
                    <div class="space property" data-index="11" onclick="showPropertyInfo(11)">
                        <div class="container">
                            <div class="color-bar purple"></div>
                            <div class="name">Pall Mall</div>
                            <div class="price">£140</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                </div>

                <!-- Corner: Free Parking -->
                <div class="space corner free-parking" data-index="20">
                    <div class="container">
                        <div class="name">Free</div>
                        <i class="fa fa-car" style="font-size: 24px; color: white;"></i>
                        <div class="name">Parking</div>
                    </div>
                </div>

                <!-- Top Row (Moving RIGHT from Free Parking to Go to Jail) -->
                <div class="row horizontal-row top-row">
                    <div class="space property" data-index="21" onclick="showPropertyInfo(21)">
                        <div class="container">
                            <div class="color-bar red"></div>
                            <div class="name">The Strand</div>
                            <div class="price">£220</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space chance" data-index="22">
                        <div class="container">
                            <div class="name">Chance</div>
                            <i class="drawing fa fa-question"></i>
                        </div>
                    </div>
                    <div class="space property" data-index="23" onclick="showPropertyInfo(23)">
                        <div class="container">
                            <div class="color-bar red"></div>
                            <div class="name">Fleet Street</div>
                            <div class="price">£220</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space property" data-index="24" onclick="showPropertyInfo(24)">
                        <div class="container">
                            <div class="color-bar red"></div>
                            <div class="name">Trafalgar</div>
                            <div class="price">£240</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space railroad" data-index="25" onclick="showPropertyInfo(25)">
                        <div class="container">
                            <div class="name">Fenchurch St</div>
                            <i class="drawing fa fa-subway"></i>
                            <div class="price">£200</div>
                        </div>
                    </div>
                    <div class="space property" data-index="26" onclick="showPropertyInfo(26)">
                        <div class="container">
                            <div class="color-bar yellow"></div>
                            <div class="name">Leicester Sq</div>
                            <div class="price">£260</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space property" data-index="27" onclick="showPropertyInfo(27)">
                        <div class="container">
                            <div class="color-bar yellow"></div>
                            <div class="name">Coventry St</div>
                            <div class="price">£260</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space utility" data-index="28" onclick="showPropertyInfo(28)">
                        <div class="container">
                            <div class="name">Water Works</div>
                            <i class="drawing fa fa-tint"></i>
                            <div class="price">£150</div>
                        </div>
                    </div>
                    <div class="space property" data-index="29" onclick="showPropertyInfo(29)">
                        <div class="container">
                            <div class="color-bar yellow"></div>
                            <div class="name">Piccadilly</div>
                            <div class="price">£280</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                </div>

                <!-- Corner: Go to Jail -->
                <div class="space corner go-to-jail" data-index="30">
                    <div class="container">
                        <div class="name">Go To</div>
                        <i class="fa fa-gavel" style="font-size: 24px; color: white;"></i>
                        <div class="name">Jail</div>
                    </div>
                </div>

                <!-- Right Row (Moving DOWN from Go to Jail to GO) -->
                <div class="row vertical-row right-row">
                    <div class="space property" data-index="31" onclick="showPropertyInfo(31)">
                        <div class="container">
                            <div class="color-bar green"></div>
                            <div class="name">Regent St</div>
                            <div class="price">£300</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space property" data-index="32" onclick="showPropertyInfo(32)">
                        <div class="container">
                            <div class="color-bar green"></div>
                            <div class="name">Oxford St</div>
                            <div class="price">£300</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space community-chest" data-index="33">
                        <div class="container">
                            <div class="name">Community</div>
                            <i class="drawing fa fa-cube"></i>
                        </div>
                    </div>
                    <div class="space property" data-index="34" onclick="showPropertyInfo(34)">
                        <div class="container">
                            <div class="color-bar green"></div>
                            <div class="name">Bond Street</div>
                            <div class="price">£320</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space railroad" data-index="35" onclick="showPropertyInfo(35)">
                        <div class="container">
                            <div class="name">Liverpool St</div>
                            <i class="drawing fa fa-subway"></i>
                            <div class="price">£200</div>
                        </div>
                    </div>
                    <div class="space chance" data-index="36">
                        <div class="container">
                            <div class="name">Chance</div>
                            <i class="drawing fa fa-question"></i>
                        </div>
                    </div>
                    <div class="space property" data-index="37" onclick="showPropertyInfo(37)">
                        <div class="container">
                            <div class="color-bar dark-blue"></div>
                            <div class="name">Park Lane</div>
                            <div class="price">£350</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                    <div class="space fee" data-index="38">
                        <div class="container">
                            <div class="name">Super Tax</div>
                            <div class="instructions">Pay £100</div>
                        </div>
                    </div>
                    <div class="space property" data-index="39" onclick="showPropertyInfo(39)">
                        <div class="container">
                            <div class="color-bar dark-blue"></div>
                            <div class="name">Mayfair</div>
                            <div class="price">£400</div>
                            <div class="development-indicator"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="game-panel">
            <!-- Learning Analytics Section -->
            <div class="panel-section">
                <h3>📈 Learning Progress</h3>
                <div class="learning-analytics">
                    <div class="analytics-grid">
                        <div class="analytics-item">
                            <span class="analytics-value" id="questions-answered">0</span>
                            <div>Questions</div>
                        </div>
                        <div class="analytics-item">
                            <span class="analytics-value" id="accuracy-rate">0%</span>
                            <div>Accuracy</div>
                        </div>
                        <div class="analytics-item">
                            <span class="analytics-value" id="learning-streak">0</span>
                            <div>Streak</div>
                        </div>
                        <div class="analytics-item">
                            <span class="analytics-value" id="achievements-count">0</span>
                            <div>Achievements</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="learning-progress"></div>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <h3>👥 Players</h3>
                <div id="players-list" class="players-list"></div>
            </div>
            
            <div class="panel-section">
                <h3>🏠 Properties</h3>
                <div id="properties-list">No properties owned</div>
            </div>

            <div class="panel-section">
                <h3>🃏 Cards</h3>
                <div id="cards-list">No cards held</div>
            </div>
        </div>
    </div>

    <!-- Question Modal -->
    <div id="question-modal" class="question-modal hidden">
        <div class="question-content">
            <h2 id="question-title" class="question-title">📚 Business Question</h2>
            <div id="difficulty-indicator" class="difficulty-indicator hidden"></div>
            <div id="timer" class="timer">
                <div class="timer-circle">
                    <span id="timer-value">30</span>
                </div>
            </div>
            <div id="question-text" class="question-text"></div>
            <div id="question-options" class="question-options"></div>
            <div id="question-result" class="hidden"></div>
        </div>
    </div>

    <!-- Card Modal -->
    <div id="card-modal" class="card-modal hidden">
        <div id="card-content" class="card-content">
            <h2 id="card-title" class="card-title">🃏 Card Drawn</h2>
            <div id="card-text" class="card-text"></div>
            <div id="card-action-text" style="margin-top: 20px; font-size: 14px; color: #666;"></div>
        </div>
    </div>

    <!-- Property Purchase Modal -->
    <div id="property-purchase-modal" class="property-purchase-modal hidden">
        <div id="property-purchase-card" class="property-purchase-card">
            <div class="property-purchase-header">
                <h2 id="purchase-property-title" class="property-purchase-title">Property Available!</h2>
                <div id="purchase-color-band" class="property-color-band"></div>
            </div>
            
            <div id="purchase-property-price" class="property-purchase-price">£200</div>
            
            <div id="purchase-property-rent" class="property-purchase-rent">
                <div class="property-rent-title">Rent Structure</div>
                <div id="purchase-rent-details"></div>
            </div>
            
            <div class="property-purchase-actions">
                <button class="btn btn-danger" onclick="declineProperty()">Pass</button>
                <button class="btn btn-primary" onclick="confirmPurchaseProperty()">Buy Property</button>
            </div>
        </div>
    </div>

    <!-- Property Info Modal -->
    <div id="property-modal" class="property-card hidden">
        <div class="property-header">
            <h3 id="property-title" class="property-title"></h3>
            <button class="property-close" onclick="hidePropertyModal()">&times;</button>
        </div>
        <div id="property-details"></div>
    </div>

    <script>
        // ====== GAME CLASSES AND MODULES ======

        class SoundManager {
            constructor() {
                this.sounds = {};
                this.muted = false;
                this.initializeSounds();
            }

            initializeSounds() {
                // Create audio context for sound effects
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Simple sound effect generation
                this.sounds = {
                    diceRoll: () => this.playTone(440, 0.1),
                    propertyPurchase: () => this.playTone(523, 0.2),
                    correctAnswer: () => this.playMelody([523, 659, 784], 0.15),
                    wrongAnswer: () => this.playTone(196, 0.3),
                    cardDraw: () => this.playTone(349, 0.1),
                    achievement: () => this.playMelody([523, 659, 784, 1047], 0.2),
                    playerMove: () => this.playTone(294, 0.05)
                };
            }

            playTone(frequency, duration) {
                if (this.muted) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playMelody(frequencies, noteDuration) {
                if (this.muted) return;
                
                frequencies.forEach((freq, index) => {
                    setTimeout(() => {
                        this.playTone(freq, noteDuration);
                    }, index * noteDuration * 1000);
                });
            }

            play(soundName) {
                if (this.sounds[soundName]) {
                    this.sounds[soundName]();
                }
            }

            toggleMute() {
                this.muted = !this.muted;
                return this.muted;
            }
        }

        class LearningAnalytics {
            constructor() {
                this.data = {
                    questionsAnswered: 0,
                    correctAnswers: 0,
                    currentStreak: 0,
                    maxStreak: 0,
                    totalTime: 0,
                    topicScores: {},
                    achievements: [],
                    difficultyProgression: 'easy'
                };
                this.loadData();
            }

            saveData() {
                try {
                    // Use temporary storage during session
                    window.tempLearningData = this.data;
                } catch (e) {
                    console.warn('Could not save learning data');
                }
            }

            loadData() {
                try {
                    if (window.tempLearningData) {
                        this.data = { ...this.data, ...window.tempLearningData };
                    }
                } catch (e) {
                    console.warn('Could not load learning data');
                }
            }

            recordAnswer(correct, topic = 'general', timeTaken = 0) {
                this.data.questionsAnswered++;
                this.data.totalTime += timeTaken;
                
                if (correct) {
                    this.data.correctAnswers++;
                    this.data.currentStreak++;
                    this.data.maxStreak = Math.max(this.data.maxStreak, this.data.currentStreak);
                } else {
                    this.data.currentStreak = 0;
                }

                // Track topic performance
                if (!this.data.topicScores[topic]) {
                    this.data.topicScores[topic] = { correct: 0, total: 0 };
                }
                this.data.topicScores[topic].total++;
                if (correct) {
                    this.data.topicScores[topic].correct++;
                }

                this.saveData();
                this.updateDifficulty();
                this.checkAchievements();
            }

            updateDifficulty() {
                const accuracy = this.getAccuracy();
                if (accuracy >= 80 && this.data.questionsAnswered >= 5) {
                    this.data.difficultyProgression = 'hard';
                } else if (accuracy >= 60 && this.data.questionsAnswered >= 3) {
                    this.data.difficultyProgression = 'medium';
                } else {
                    this.data.difficultyProgression = 'easy';
                }
            }

            checkAchievements() {
                const achievements = [
                    { id: 'first_correct', name: 'First Success', icon: '🎯', condition: () => this.data.correctAnswers >= 1 },
                    { id: 'streak_5', name: 'Learning Streak', icon: '🔥', condition: () => this.data.currentStreak >= 5 },
                    { id: 'accuracy_master', name: 'Accuracy Master', icon: '🎖️', condition: () => this.getAccuracy() >= 90 && this.data.questionsAnswered >= 10 },
                    { id: 'question_veteran', name: 'Question Veteran', icon: '📚', condition: () => this.data.questionsAnswered >= 25 },
                    { id: 'streak_master', name: 'Streak Master', icon: '⚡', condition: () => this.data.maxStreak >= 10 }
                ];

                achievements.forEach(achievement => {
                    if (!this.data.achievements.includes(achievement.id) && achievement.condition()) {
                        this.data.achievements.push(achievement.id);
                        this.showAchievement(achievement);
                    }
                });
            }

            showAchievement(achievement) {
                soundManager.play('achievement');
                
                const popup = document.createElement('div');
                popup.className = 'achievement-popup';
                popup.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-title">Achievement Unlocked!</div>
                    <div class="achievement-description">${achievement.name}</div>
                `;
                
                document.body.appendChild(popup);
                
                setTimeout(() => {
                    popup.style.animation = 'achievementSlide 0.5s ease-out reverse';
                    setTimeout(() => popup.remove(), 500);
                }, 3000);
            }

            getAccuracy() {
                return this.data.questionsAnswered > 0 ? 
                    Math.round((this.data.correctAnswers / this.data.questionsAnswered) * 100) : 0;
            }

            getAverageTime() {
                return this.data.questionsAnswered > 0 ? 
                    Math.round(this.data.totalTime / this.data.questionsAnswered) : 0;
            }

            getDifficulty() {
                return this.data.difficultyProgression;
            }

            updateDisplay() {
                document.getElementById('questions-answered').textContent = this.data.questionsAnswered;
                document.getElementById('accuracy-rate').textContent = `${this.getAccuracy()}%`;
                document.getElementById('learning-streak').textContent = this.data.currentStreak;
                document.getElementById('achievements-count').textContent = this.data.achievements.length;
                
                const progress = Math.min(100, (this.data.questionsAnswered / 50) * 100);
                document.getElementById('learning-progress').style.width = `${progress}%`;
            }
        }

        class PropertyManager {
            constructor() {
                this.properties = this.initializeProperties();
            }

            initializeProperties() {
                return {
                    1: { name: 'Old Kent Road', price: 60, rent: [2, 10, 30, 90, 160, 250], color: 'dark-purple', houses: 0, owner: null },
                    3: { name: 'Whitechapel Road', price: 60, rent: [4, 20, 60, 180, 320, 450], color: 'dark-purple', houses: 0, owner: null },
                    6: { name: 'The Angel Islington', price: 100, rent: [6, 30, 90, 270, 400, 550], color: 'light-blue', houses: 0, owner: null },
                    8: { name: 'Euston Road', price: 100, rent: [6, 30, 90, 270, 400, 550], color: 'light-blue', houses: 0, owner: null },
                    9: { name: 'Pentonville Road', price: 120, rent: [8, 40, 100, 300, 450, 600], color: 'light-blue', houses: 0, owner: null },
                    11: { name: 'Pall Mall', price: 140, rent: [10, 50, 150, 450, 625, 750], color: 'purple', houses: 0, owner: null },
                    13: { name: 'Whitehall', price: 140, rent: [10, 50, 150, 450, 625, 750], color: 'purple', houses: 0, owner: null },
                    14: { name: 'Northumberland Avenue', price: 160, rent: [12, 60, 180, 500, 700, 900], color: 'purple', houses: 0, owner: null },
                    16: { name: 'Bow Street', price: 180, rent: [14, 70, 200, 550, 750, 950], color: 'orange', houses: 0, owner: null },
                    18: { name: 'Marlborough Street', price: 180, rent: [14, 70, 200, 550, 750, 950], color: 'orange', houses: 0, owner: null },
                    19: { name: 'Vine Street', price: 200, rent: [16, 80, 220, 600, 800, 1000], color: 'orange', houses: 0, owner: null },
                    21: { name: 'The Strand', price: 220, rent: [18, 90, 250, 700, 875, 1050], color: 'red', houses: 0, owner: null },
                    23: { name: 'Fleet Street', price: 220, rent: [18, 90, 250, 700, 875, 1050], color: 'red', houses: 0, owner: null },
                    24: { name: 'Trafalgar Square', price: 240, rent: [20, 100, 300, 750, 925, 1100], color: 'red', houses: 0, owner: null },
                    26: { name: 'Leicester Square', price: 260, rent: [22, 110, 330, 800, 975, 1150], color: 'yellow', houses: 0, owner: null },
                    27: { name: 'Coventry Street', price: 260, rent: [22, 110, 330, 800, 975, 1150], color: 'yellow', houses: 0, owner: null },
                    29: { name: 'Piccadilly', price: 280, rent: [24, 120, 360, 850, 1025, 1200], color: 'yellow', houses: 0, owner: null },
                    31: { name: 'Regent Street', price: 300, rent: [26, 130, 390, 900, 1100, 1275], color: 'green', houses: 0, owner: null },
                    32: { name: 'Oxford Street', price: 300, rent: [26, 130, 390, 900, 1100, 1275], color: 'green', houses: 0, owner: null },
                    34: { name: 'Bond Street', price: 320, rent: [28, 150, 450, 1000, 1200, 1400], color: 'green', houses: 0, owner: null },
                    37: { name: 'Park Lane', price: 350, rent: [35, 175, 500, 1100, 1300, 1500], color: 'dark-blue', houses: 0, owner: null },
                    39: { name: 'Mayfair', price: 400, rent: [50, 200, 600, 1400, 1700, 2000], color: 'dark-blue', houses: 0, owner: null },
                    // Railroads and Utilities
                    5: { name: "King's Cross Station", price: 200, rent: [25, 50, 100, 200], type: 'railroad', owner: null },
                    15: { name: 'Marylebone Station', price: 200, rent: [25, 50, 100, 200], type: 'railroad', owner: null },
                    25: { name: 'Fenchurch Street Station', price: 200, rent: [25, 50, 100, 200], type: 'railroad', owner: null },
                    35: { name: 'Liverpool Street Station', price: 200, rent: [25, 50, 100, 200], type: 'railroad', owner: null },
                    12: { name: 'Electric Company', price: 150, rent: [4, 10], type: 'utility', owner: null },
                    28: { name: 'Water Works', price: 150, rent: [4, 10], type: 'utility', owner: null }
                };
            }

            getProperty(index) {
                return this.properties[index] || null;
            }

            buyProperty(index, playerId) {
                if (this.properties[index] && !this.properties[index].owner) {
                    this.properties[index].owner = playerId;
                    return true;
                }
                return false;
            }

            developProperty(index) {
                const property = this.properties[index];
                if (property && property.houses < 5 && property.type !== 'railroad' && property.type !== 'utility') {
                    property.houses++;
                    return true;
                }
                return false;
            }

            calculateRent(index, diceRoll = 0) {
                const property = this.properties[index];
                if (!property || !property.owner) return 0;

                if (property.type === 'railroad') {
                    const ownedRailroads = Object.values(this.properties)
                        .filter(p => p.type === 'railroad' && p.owner === property.owner).length;
                    return property.rent[ownedRailroads - 1] || 0;
                }

                if (property.type === 'utility') {
                    const ownedUtilities = Object.values(this.properties)
                        .filter(p => p.type === 'utility' && p.owner === property.owner).length;
                    const multiplier = ownedUtilities === 1 ? 4 : 10;
                    return diceRoll * multiplier;
                }

                return property.rent[property.houses] || property.rent[0];
            }

            updatePropertyDisplay(index) {
                const property = this.properties[index];
                const element = document.querySelector(`[data-index="${index}"]`);
                if (!element || !property) return;

                // Add ownership styling
                if (property.owner !== null) {
                    element.classList.add('owned');
                }

                // Add development indicator
                const indicator = element.querySelector('.development-indicator');
                if (indicator && property.houses > 0) {
                    indicator.innerHTML = '';
                    for (let i = 0; i < Math.min(property.houses, 4); i++) {
                        const house = document.createElement('div');
                        house.className = 'development-house';
                        indicator.appendChild(house);
                    }
                    if (property.houses === 5) {
                        indicator.innerHTML = '<div class="development-hotel"></div>';
                    }
                    element.classList.add('developed');
                }
            }

            getPlayerProperties(playerId) {
                return Object.entries(this.properties)
                    .filter(([index, property]) => property.owner === playerId)
                    .map(([index, property]) => ({ index: parseInt(index), ...property }));
            }

            canDevelop(playerId, propertyIndex) {
                const property = this.properties[propertyIndex];
                if (!property || property.owner !== playerId || property.houses >= 5) return false;
                if (property.type === 'railroad' || property.type === 'utility') return false;

                // Check if player owns all properties in the color group
                const colorGroup = Object.entries(this.properties)
                    .filter(([index, prop]) => prop.color === property.color && prop.color);
                
                const allOwned = colorGroup.every(([index, prop]) => prop.owner === playerId);
                return allOwned;
            }
        }

        class GameController {
            constructor() {
                this.socket = io('https://business-monopoly-server.onrender.com');
                this.currentRoom = null;
                this.currentPlayer = null;
                this.gameData = null;
                this.canBuyProperty = false;
                this.propertyToBuy = null;
                this.isPlayerMoving = false;
                this.initializeSocketEvents();
                this.initializeKeyboardNavigation();
            }

            initializeSocketEvents() {
                this.socket.on('connect', () => {
                    console.log('✅ Connected to server');
                });

                this.socket.on('disconnect', () => {
                    console.log('❌ Disconnected from server');
                    this.showReconnectMessage();
                });

                this.socket.on('roomCreated', (roomCode) => {
                    this.currentRoom = roomCode;
                    this.currentPlayer = document.getElementById('playerName').value.trim();
                    document.getElementById('room-code').textContent = roomCode;
                    document.getElementById('room-created').classList.remove('hidden');
                });

                this.socket.on('roomJoined', (data) => {
                    this.currentRoom = data.roomCode;
                    this.currentPlayer = document.getElementById('playerName').value.trim();
                    document.getElementById('room-setup').classList.add('hidden');
                    document.getElementById('game-container').classList.remove('hidden');
                    this.updatePlayersDisplay(data.players);
                });

                this.socket.on('playersUpdated', (players) => {
                    this.updatePlayersDisplay(players);
                    
                    if (this.currentRoom && players.length >= 2) {
                        const hostPlayer = players.find(p => p.isHost);
                        if (hostPlayer && hostPlayer.name === this.currentPlayer) {
                            document.getElementById('start-game-btn').classList.remove('hidden');
                        }
                    }
                });

                this.socket.on('gameStarted', (room) => {
                    document.getElementById('room-setup').classList.add('hidden');
                    document.getElementById('game-container').classList.remove('hidden');
                    this.gameData = room;
                    
                    // Ensure all players start at GO (position 0)
                    this.gameData.players.forEach(player => {
                        if (player.position === undefined) {
                            player.position = 0;
                        }
                    });
                    
                    this.updatePlayersDisplay(room.players);
                    this.updateTurnIndicator();
                    this.updateGameControls();
                    this.updatePlayerPieces();
                    this.updateCardsDisplay();
                    learningAnalytics.updateDisplay();
                });

                this.socket.on('gameUpdated', (room) => {
                    this.gameData = room;
                    this.updatePlayersDisplay(room.players);
                    this.updateTurnIndicator();
                    this.updateGameControls();
                    
                    // Only update player pieces if not currently animating movement
                    if (!this.isPlayerMoving) {
                        this.updatePlayerPieces();
                    }
                    
                    this.updatePropertiesDisplay();
                    this.updateCardsDisplay();
                });

                this.socket.on('questionReceived', (question) => {
                    this.showQuestion(question);
                });

                this.socket.on('answerResult', (result) => {
                    this.hideQuestion();
                    
                    const correct = result.correct;
                    learningAnalytics.recordAnswer(correct, 'business', result.timeTaken || 0);
                    learningAnalytics.updateDisplay();
                    
                    soundManager.play(correct ? 'correctAnswer' : 'wrongAnswer');
                    
                    const resultText = correct ? 
                        `✅ Correct! ${result.explanation}` : 
                        `❌ Wrong! ${result.explanation}`;
                    
                    this.showMessage(resultText, correct ? 'success' : 'error');
                });

                this.socket.on('diceRolled', (result) => {
                    this.handleDiceResult(result);
                });

                this.socket.on('propertyPurchased', (data) => {
                    soundManager.play('propertyPurchase');
                    this.showMessage(`🏠 ${data.playerName} bought ${data.propertyName} for £${data.price}`, 'info');
                    
                    this.gameData = data.gameData;
                    this.canBuyProperty = false;
                    this.propertyToBuy = null;
                    
                    // Update property display
                    propertyManager.buyProperty(data.propertyIndex, data.playerId);
                    propertyManager.updatePropertyDisplay(data.propertyIndex);
                    
                    this.updatePropertiesDisplay();
                    this.updateCardsDisplay();
                });

                this.socket.on('error', (message) => {
                    this.showMessage('Error: ' + message, 'error');
                });
            }

            initializeKeyboardNavigation() {
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT') return;

                    switch(e.key) {
                        case ' ': // Spacebar
                            e.preventDefault();
                            const rollBtn = document.getElementById('roll-dice-btn');
                            if (!rollBtn.classList.contains('hidden')) {
                                this.rollDice();
                            }
                            break;
                        case 'Enter':
                            e.preventDefault();
                            const startBtn = document.getElementById('start-turn-btn');
                            if (!startBtn.classList.contains('hidden')) {
                                this.startTurn();
                            }
                            break;
                        case 'b':
                            const buyBtn = document.getElementById('buy-property-btn');
                            if (!buyBtn.classList.contains('hidden')) {
                                this.buyProperty();
                            }
                            break;
                        case 'e':
                            const endBtn = document.getElementById('end-turn-btn');
                            if (!endBtn.classList.contains('hidden')) {
                                this.endTurn();
                            }
                            break;
                    }
                });
            }

            showReconnectMessage() {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.8); display: flex; align-items: center;
                    justify-content: center; z-index: 2000;
                `;
                overlay.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 15px; text-align: center;">
                        <h3>Connection Lost</h3>
                        <p>Attempting to reconnect...</p>
                        <div style="animation: spin 1s linear infinite;">🔄</div>
                    </div>
                `;
                document.body.appendChild(overlay);

                // Remove overlay when reconnected
                this.socket.on('connect', () => {
                    overlay.remove();
                });
            }

            createRoom() {
                const playerName = document.getElementById('playerName').value.trim();
                if (!playerName) {
                    this.showMessage('Please enter your name', 'error');
                    return;
                }
                
                this.socket.emit('createRoom', { playerName });
            }

            showJoinForm() {
                document.getElementById('join-form').classList.remove('hidden');
            }

            joinRoom() {
                const playerName = document.getElementById('playerName').value.trim();
                const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
                
                if (!playerName || !roomCode) {
                    this.showMessage('Please enter your name and room code', 'error');
                    return;
                }
                
                this.socket.emit('joinRoom', { roomCode, playerName });
            }

            startGame() {
                this.socket.emit('startGame', this.currentRoom);
            }

            startTurn() {
                this.socket.emit('startTurn', this.currentRoom);
            }

            rollDice() {
                soundManager.play('diceRoll');
                
                // Disable roll button during animation
                const rollBtn = document.getElementById('roll-dice-btn');
                rollBtn.disabled = true;
                rollBtn.textContent = 'Rolling...';

                // Show dice rolling animation with "?" symbols in center
                const diceResult = document.getElementById('center-dice-result');
                diceResult.innerHTML = `
                    <div class="dice-container">
                        <div class="dice rolling" id="dice1">?</div>
                        <div class="dice rolling" id="dice2">?</div>
                    </div>
                    <div class="dice-total">Rolling dice...</div>
                `;
                diceResult.classList.remove('hidden');

                // Send actual roll request after 2 seconds of animation
                setTimeout(() => {
                    this.socket.emit('rollDice', this.currentRoom);
                }, 2000);
            }

            buyProperty() {
                if (this.canBuyProperty && this.propertyToBuy !== null) {
                    const currentPlayerData = this.gameData.players[this.gameData.currentPlayer];
                    const propertyIndex = currentPlayerData.position;
                    this.socket.emit('buyProperty', { roomCode: this.currentRoom, propertyIndex: propertyIndex });
                }
            }

            showDevelopmentOptions() {
                const currentPlayerData = this.gameData.players[this.gameData.currentPlayer];
                const playerId = this.gameData.currentPlayer;
                const properties = propertyManager.getPlayerProperties(playerId);
                const developable = properties.filter(prop => propertyManager.canDevelop(playerId, prop.index));

                if (developable.length === 0) {
                    this.showMessage('No properties can be developed', 'info');
                    return;
                }

                this.showMessage(`You can develop ${developable.length} properties`, 'info');
                // Implementation for development UI would go here
            }

            showPropertyPurchaseModal(propertyIndex) {
                const property = propertyManager.getProperty(propertyIndex);
                if (!property) return;

                const modal = document.getElementById('property-purchase-modal');
                const card = document.getElementById('property-purchase-card');
                const title = document.getElementById('purchase-property-title');
                const colorBand = document.getElementById('purchase-color-band');
                const price = document.getElementById('purchase-property-price');
                const rentDetails = document.getElementById('purchase-rent-details');

                title.textContent = property.name;
                price.textContent = `£${property.price}`;

                // Set color band
                if (property.color) {
                    colorBand.className = `property-color-band ${property.color}`;
                } else if (property.type) {
                    colorBand.className = `property-color-band ${property.type}`;
                } else {
                    colorBand.style.display = 'none';
                }

                // Set rent structure
                let rentHTML = '';
                if (property.type === 'railroad') {
                    rentHTML = `
                        <div class="property-rent-item"><span>1 Railroad owned:</span><span>£${property.rent[0]}</span></div>
                        <div class="property-rent-item"><span>2 Railroads owned:</span><span>£${property.rent[1]}</span></div>
                        <div class="property-rent-item"><span>3 Railroads owned:</span><span>£${property.rent[2]}</span></div>
                        <div class="property-rent-item"><span>4 Railroads owned:</span><span>£${property.rent[3]}</span></div>
                    `;
                } else if (property.type === 'utility') {
                    rentHTML = `
                        <div class="property-rent-item"><span>1 Utility owned:</span><span>4x dice roll</span></div>
                        <div class="property-rent-item"><span>2 Utilities owned:</span><span>10x dice roll</span></div>
                    `;
                } else if (property.rent) {
                    rentHTML = `
                        <div class="property-rent-item"><span>Base rent:</span><span>£${property.rent[0]}</span></div>
                        <div class="property-rent-item"><span>With 1 house:</span><span>£${property.rent[1]}</span></div>
                        <div class="property-rent-item"><span>With 2 houses:</span><span>£${property.rent[2]}</span></div>
                        <div class="property-rent-item"><span>With 3 houses:</span><span>£${property.rent[3]}</span></div>
                        <div class="property-rent-item"><span>With 4 houses:</span><span>£${property.rent[4]}</span></div>
                        <div class="property-rent-item"><span>With hotel:</span><span>£${property.rent[5]}</span></div>
                    `;
                }
                rentDetails.innerHTML = rentHTML;

                modal.classList.remove('hidden');
                setTimeout(() => card.classList.add('show'), 10);
            }

            hidePropertyPurchaseModal() {
                const modal = document.getElementById('property-purchase-modal');
                const card = document.getElementById('property-purchase-card');
                
                card.classList.remove('show');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }

            endTurn() {
                this.socket.emit('endTurn', this.currentRoom);
            }

            handleDiceResult(result) {
                // Re-enable roll button
                const rollBtn = document.getElementById('roll-dice-btn');
                rollBtn.disabled = false;
                rollBtn.textContent = 'Roll Dice';

                // Show final dice results in center
                const diceResult = document.getElementById('center-dice-result');
                const total = result.dice[0] + result.dice[1];
                
                diceResult.innerHTML = `
                    <div class="dice-container">
                        <div class="dice" id="dice1">${result.dice[0]}</div>
                        <div class="dice" id="dice2">${result.dice[1]}</div>
                    </div>
                    <div class="dice-total">Total: ${total} spaces</div>
                `;

                // Store movement data
                this.canBuyProperty = result.canBuyProperty;
                this.propertyToBuy = result.canBuyProperty ? result.newPosition : null;

                // Get current player data before movement
                const currentPlayerData = this.gameData.players[this.gameData.currentPlayer];
                const oldPosition = currentPlayerData.position;
                const newPosition = result.newPosition;

                // Check if this is the current player's turn
                const isMyTurn = currentPlayerData && currentPlayerData.name === this.currentPlayer;

                // Show rent payment message if applicable (after movement completes)
                if (result.rentOwed > 0) {
                    setTimeout(() => {
                        this.showMessage(`💰 Paid £${result.rentOwed} rent`, 'error');
                    }, total * 600 + 1000);
                }

                // Update the turn indicator
                this.updateTurnIndicator();

                // Start animated movement after short delay
                setTimeout(() => {
                    this.isPlayerMoving = true;
                    this.animatePlayerMovement(this.gameData.currentPlayer, oldPosition, newPosition, total);
                }, 1000);

                // Show property purchase modal after movement (ONLY for the current player)
                if (result.canBuyProperty && isMyTurn) {
                    setTimeout(() => {
                        this.showPropertyPurchaseModal(newPosition);
                    }, total * 600 + 1500);
                }
            }

            animatePlayerMovement(playerIndex, fromPosition, toPosition, totalSteps) {
                const piece = document.getElementById(`player-${playerIndex}`);
                if (!piece) {
                    console.error(`Player piece not found: player-${playerIndex}`);
                    return;
                }

                console.log(`Animating player ${playerIndex} movement: ${fromPosition} → ${toPosition} (${totalSteps} steps)`);

                let currentPosition = fromPosition;
                let stepsRemaining = totalSteps;

                // Highlight destination
                const destinationSquare = document.querySelector(`[data-index="${toPosition}"]`);
                if (destinationSquare) {
                    destinationSquare.style.boxShadow = '0 0 calc(25px * var(--scale)) #FFD700';
                    destinationSquare.style.border = 'calc(3px * var(--scale)) solid #FFD700';
                    destinationSquare.style.transform = 'scale(1.05)';
                    destinationSquare.style.zIndex = '50';
                }

                const moveOneStep = () => {
                    if (stepsRemaining <= 0) {
                        console.log(`Movement complete. Final position: ${currentPosition}`);
                        
                        // Clear movement flag
                        this.isPlayerMoving = false;
                        
                        // Update game data with final position
                        if (this.gameData && this.gameData.players[playerIndex]) {
                            this.gameData.players[playerIndex].position = toPosition;
                        }
                        
                        // Clear destination highlighting
                        if (destinationSquare) {
                            destinationSquare.style.boxShadow = '';
                            destinationSquare.style.border = '';
                            destinationSquare.style.transform = '';
                            destinationSquare.style.zIndex = '';
                        }
                        
                        // Remove moving animation
                        piece.classList.remove('moving');
                        
                        // Handle special spaces after movement completes
                        setTimeout(() => {
                            this.handleSpecialSpace(playerIndex, toPosition);
                            this.updateGameControls();
                            this.updatePlayersDisplay(this.gameData.players);
                        }, 500);
                        
                        return;
                    }

                    // Calculate next position (clockwise around board)
                    currentPosition = (currentPosition + 1) % 40;
                    stepsRemaining--;

                    console.log(`Moving to position ${currentPosition}, ${stepsRemaining} steps remaining`);

                    // Check if passing GO
                    if (currentPosition === 0 && stepsRemaining > 0) {
                        this.showMessage('🎯 Passed GO! Collect £200', 'success');
                        if (this.gameData && this.gameData.players[playerIndex]) {
                            this.gameData.players[playerIndex].money += 200;
                        }
                    }

                    // Move piece to new position
                    const newProperty = document.querySelector(`[data-index="${currentPosition}"]`);
                    if (newProperty) {
                        // Remove piece from current location
                        piece.remove();
                        
                        // Add to new location
                        newProperty.appendChild(piece);
                        
                        // Reset positioning
                        piece.style.left = '50%';
                        piece.style.top = '50%';
                        piece.style.transform = 'translate(-50%, -50%)';
                        
                        // Add moving animation
                        piece.classList.add('moving');
                        soundManager.play('playerMove');
                        
                        // Continue to next step after delay
                        setTimeout(() => {
                            moveOneStep();
                        }, 600);
                    } else {
                        console.error(`Could not find property element for position ${currentPosition}`);
                        setTimeout(moveOneStep, 600);
                    }
                };

                // Start the movement
                moveOneStep();
            }

            handleSpecialSpace(playerIndex, position) {
                const space = document.querySelector(`[data-index="${position}"]`);
                if (space) {
                    space.classList.add('special-landed');
                    setTimeout(() => space.classList.remove('special-landed'), 2000);
                }

                console.log(`Player ${playerIndex} landed on space ${position}`);
                
                // Only handle card effects if this is the current player's turn
                const isCurrentPlayer = this.gameData && this.gameData.currentPlayer === playerIndex;
                const isMyTurn = this.gameData && this.gameData.players[this.gameData.currentPlayer]?.name === this.currentPlayer;
                
                if (!isCurrentPlayer || !isMyTurn) {
                    return;
                }

                // Handle different special spaces
                switch(position) {
                    case 2: // Community Chest
                    case 17:
                    case 33:
                        setTimeout(() => this.handleCommunityChest(playerIndex), 1000);
                        break;
                    case 7: // Chance
                    case 22:
                    case 36:
                        setTimeout(() => this.handleChance(playerIndex), 1000);
                        break;
                    case 30: // Go to Jail
                        setTimeout(() => this.handleGoToJail(playerIndex), 1000);
                        break;
                    case 4: // Income Tax
                        this.handleIncomeTax(playerIndex);
                        break;
                    case 38: // Super Tax
                        this.handleSuperTax(playerIndex);
                        break;
                    case 0: // GO
                        this.showMessage('🎯 Welcome to GO! Collect £200', 'success');
                        break;
                    case 10: // Just Visiting Jail
                    case 20: // Free Parking
                        // No special action needed
                        break;
                    default:
                        // Regular property space
                        break;
                }
            }

            handleChance(playerIndex) {
                const card = this.drawRandomCard('chance');
                console.log('Chance card drawn:', card);
                
                soundManager.play('cardDraw');
                
                const playerName = this.gameData.players[playerIndex]?.name || 'Player';
                this.showMessage(`${playerName} drew a Chance card!`, 'info');
                
                this.showCardModal('❓ Chance Card', card.text, 'chance');
                
                setTimeout(() => {
                    this.executeCardAction(playerIndex, card);
                }, 2000);
            }

            handleCommunityChest(playerIndex) {
                const card = this.drawRandomCard('community');
                console.log('Community Chest card drawn:', card);
                
                soundManager.play('cardDraw');
                
                const playerName = this.gameData.players[playerIndex]?.name || 'Player';
                this.showMessage(`${playerName} drew a Community Chest card!`, 'info');
                
                this.showCardModal('📦 Community Chest', card.text, 'community');
                
                setTimeout(() => {
                    this.executeCardAction(playerIndex, card);
                }, 2000);
            }

            handleGoToJail(playerIndex) {
                const collegeMessage = document.createElement('div');
                collegeMessage.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #4CAF50, #45a049); 
                    color: white; padding: calc(24px * var(--scale)); border-radius: calc(16px * var(--scale)); 
                    max-width: calc(315px * var(--scale)); z-index: 1002; text-align: center;
                    border: calc(3px * var(--scale)) solid #2e7d32; box-shadow: 0 calc(8px * var(--scale)) calc(24px * var(--scale)) rgba(0,0,0,0.4);
                    font-size: calc(14px * var(--scale)); font-weight: bold;
                `;
                collegeMessage.innerHTML = `
                    <div style="font-size: calc(38px * var(--scale)); margin-bottom: calc(12px * var(--scale));">🎓👮‍♂️</div>
                    <div style="font-size: calc(16px * var(--scale)); margin-bottom: calc(8px * var(--scale));">Go to Jail?</div>
                    <div style="font-size: calc(13px * var(--scale)); line-height: 1.5;">
                        "I cannot send you to Jail whilst you are at college!"
                    </div>
                    <div style="font-size: calc(11px * var(--scale)); margin-top: calc(12px * var(--scale)); opacity: 0.9;">
                        Education protects you! Stay on this space.
                    </div>
                `;
                
                document.body.appendChild(collegeMessage);
                
                setTimeout(() => {
                    collegeMessage.style.transition = 'all 0.5s ease';
                    collegeMessage.style.transform = 'translate(-50%, -50%) scale(1)';
                    collegeMessage.style.opacity = '1';
                }, 100);
                
                setTimeout(() => {
                    collegeMessage.style.transition = 'all 0.5s ease';
                    collegeMessage.style.transform = 'translate(-50%, -50%) scale(0.5)';
                    collegeMessage.style.opacity = '0';
                    setTimeout(() => collegeMessage.remove(), 500);
                }, 4000);
                
                this.showMessage('🎓 Education keeps you free! No jail time for students!', 'success');
            }

            handleIncomeTax(playerIndex) {
                this.showMessage('💰 Income Tax - Pay £200', 'error');
                if (this.gameData && this.gameData.players[playerIndex]) {
                    this.gameData.players[playerIndex].money = Math.max(0, this.gameData.players[playerIndex].money - 200);
                    this.updatePlayersDisplay(this.gameData.players);
                }
            }

            handleSuperTax(playerIndex) {
                this.showMessage('💰 Super Tax - Pay £100', 'error');
                if (this.gameData && this.gameData.players[playerIndex]) {
                    this.gameData.players[playerIndex].money = Math.max(0, this.gameData.players[playerIndex].money - 100);
                    this.updatePlayersDisplay(this.gameData.players);
                }
            }

            drawRandomCard(cardType) {
                const chanceCards = [
                    { text: "Advance to GO - Collect £200", action: "moveToGo" },
                    { text: "Go to Jail - Go directly to Jail", action: "goToJail" },
                    { text: "Advance to Trafalgar Square", action: "moveTo", position: 24 },
                    { text: "Advance to Mayfair", action: "moveTo", position: 39 },
                    { text: "Advance to nearest Railway Station and pay owner twice the rental", action: "moveToNearestRailway" },
                    { text: "Go back 3 spaces", action: "moveBack", spaces: 3 },
                    { text: "Pay poor tax of £15", action: "payMoney", amount: 15 },
                    { text: "Your building loan matures - Collect £150", action: "receiveMoney", amount: 150 },
                    { text: "You have won a crossword competition - Collect £100", action: "receiveMoney", amount: 100 },
                    { text: "Bank pays you dividend of £50", action: "receiveMoney", amount: 50 },
                    { text: "Get out of Jail Free - Keep until needed", action: "getOutOfJail" },
                    { text: "Advance to Pall Mall", action: "moveTo", position: 11 },
                    { text: "Take a trip to King's Cross Station", action: "moveTo", position: 5 },
                    { text: "Make general repairs on all your houses - £25 per house", action: "propertyRepairs", amount: 25 },
                    { text: "Move forward to the nearest Utility", action: "moveToNearestUtility" }
                ];

                const communityChestCards = [
                    { text: "Advance to GO - Collect £200", action: "moveToGo" },
                    { text: "Go to Jail - Go directly to Jail", action: "goToJail" },
                    { text: "Doctor's fee - Pay £50", action: "payMoney", amount: 50 },
                    { text: "From sale of stock you get £50", action: "receiveMoney", amount: 50 },
                    { text: "Holiday fund matures - Receive £100", action: "receiveMoney", amount: 100 },
                    { text: "Income tax refund - Collect £20", action: "receiveMoney", amount: 20 },
                    { text: "Get out of Jail Free - Keep until needed", action: "getOutOfJail" },
                    { text: "Life insurance matures - Collect £100", action: "receiveMoney", amount: 100 },
                    { text: "Hospital fees - Pay £100", action: "payMoney", amount: 100 },
                    { text: "School fees - Pay £50", action: "payMoney", amount: 50 },
                    { text: "Receive £25 consultancy fee", action: "receiveMoney", amount: 25 },
                    { text: "You have won second prize in a beauty contest - Collect £10", action: "receiveMoney", amount: 10 },
                    { text: "You inherit £100", action: "receiveMoney", amount: 100 },
                    { text: "Pay hospital fees of £100", action: "payMoney", amount: 100 },
                    { text: "Pay school fees of £150", action: "payMoney", amount: 150 },
                    { text: "Receive £50 from sale of stock", action: "receiveMoney", amount: 50 }
                ];

                const cards = cardType === 'chance' ? chanceCards : communityChestCards;
                return cards[Math.floor(Math.random() * cards.length)];
            }

            executeCardAction(playerIndex, card) {
                if (!this.gameData || !this.gameData.players[playerIndex]) return;
                
                const player = this.gameData.players[playerIndex];
                const currentPosition = player.position;
                
                console.log(`Executing card action: ${card.action}`, card);
                
                switch(card.action) {
                    case 'moveToGo':
                        this.movePlayerTo(playerIndex, 0);
                        player.money += 200;
                        this.showMessage('🎯 Moved to GO! Collect £200', 'success');
                        break;
                        
                    case 'goToJail':
                        this.handleGoToJail(playerIndex);
                        break;
                        
                    case 'moveTo':
                        this.movePlayerTo(playerIndex, card.position);
                        if (card.position < currentPosition) {
                            player.money += 200;
                            this.showMessage('🎯 Passed GO! Collect £200', 'success');
                        }
                        break;
                        
                    case 'moveBack':
                        this.movePlayerBack(playerIndex, card.spaces);
                        break;
                        
                    case 'moveToNearestRailway':
                        const railways = [5, 15, 25, 35];
                        let nearestRailway = railways.find(pos => pos > currentPosition);
                        if (!nearestRailway) nearestRailway = railways[0];
                        
                        this.movePlayerTo(playerIndex, nearestRailway);
                        if (nearestRailway < currentPosition) {
                            player.money += 200;
                            this.showMessage('🎯 Passed GO! Collect £200', 'success');
                        }
                        this.showMessage('🚂 Moved to nearest Railway Station', 'info');
                        break;
                        
                    case 'moveToNearestUtility':
                        const utilities = [12, 28];
                        let nearestUtility = utilities.find(pos => pos > currentPosition);
                        if (!nearestUtility) nearestUtility = utilities[0];
                        
                        this.movePlayerTo(playerIndex, nearestUtility);
                        if (nearestUtility < currentPosition) {
                            player.money += 200;
                            this.showMessage('🎯 Passed GO! Collect £200', 'success');
                        }
                        this.showMessage('⚡ Moved to nearest Utility', 'info');
                        break;
                        
                    case 'payMoney':
                        player.money = Math.max(0, player.money - card.amount);
                        this.showMessage(`💰 Pay £${card.amount}`, 'error');
                        break;
                        
                    case 'receiveMoney':
                        player.money += card.amount;
                        this.showMessage(`💰 Receive £${card.amount}`, 'success');
                        break;
                        
                    case 'getOutOfJail':
                        if (!player.cards) player.cards = [];
                        player.cards.push({ type: 'Get Out of Jail Free', text: card.text });
                        this.showMessage('🔓 Get Out of Jail Free card added!', 'info');
                        this.updateCardsDisplay();
                        break;
                        
                    case 'propertyRepairs':
                        const repairCost = player.properties.length * card.amount;
                        player.money = Math.max(0, player.money - repairCost);
                        this.showMessage(`🔧 Property repairs: £${repairCost}`, 'error');
                        break;
                }
                
                this.updatePlayersDisplay(this.gameData.players);
            }

            movePlayerTo(playerIndex, targetPosition) {
                if (!this.gameData || !this.gameData.players[playerIndex]) return;
                
                const player = this.gameData.players[playerIndex];
                const currentPosition = player.position;
                
                console.log(`Moving player ${playerIndex} from ${currentPosition} to ${targetPosition}`);
                
                let steps;
                if (targetPosition >= currentPosition) {
                    steps = targetPosition - currentPosition;
                } else {
                    steps = (40 - currentPosition) + targetPosition;
                }
                
                this.isPlayerMoving = true;
                this.animatePlayerMovement(playerIndex, currentPosition, targetPosition, steps);
            }

            movePlayerBack(playerIndex, spacesToMoveBack) {
                if (!this.gameData || !this.gameData.players[playerIndex]) return;
                
                const player = this.gameData.players[playerIndex];
                const currentPosition = player.position;
                const targetPosition = (currentPosition - spacesToMoveBack + 40) % 40;
                
                console.log(`Moving player ${playerIndex} BACKWARD from ${currentPosition} to ${targetPosition} (${spacesToMoveBack} spaces back)`);
                
                this.isPlayerMoving = true;
                this.animatePlayerMovementBackward(playerIndex, currentPosition, targetPosition, spacesToMoveBack);
            }

            animatePlayerMovementBackward(playerIndex, fromPosition, toPosition, totalSteps) {
                const piece = document.getElementById(`player-${playerIndex}`);
                if (!piece) {
                    console.error(`Player piece not found: player-${playerIndex}`);
                    return;
                }

                console.log(`Animating player ${playerIndex} BACKWARD movement: ${fromPosition} → ${toPosition} (${totalSteps} steps)`);

                let currentPosition = fromPosition;
                let stepsRemaining = totalSteps;

                // Highlight destination
                const destinationSquare = document.querySelector(`[data-index="${toPosition}"]`);
                if (destinationSquare) {
                    destinationSquare.style.boxShadow = '0 0 calc(25px * var(--scale)) #FFD700';
                    destinationSquare.style.border = 'calc(3px * var(--scale)) solid #FFD700';
                    destinationSquare.style.transform = 'scale(1.05)';
                    destinationSquare.style.zIndex = '50';
                }

                const moveOneStepBackward = () => {
                    if (stepsRemaining <= 0) {
                        console.log(`Backward movement complete. Final position: ${currentPosition}`);
                        
                        // Clear movement flag
                        this.isPlayerMoving = false;
                        
                        // Update game data with final position
                        if (this.gameData && this.gameData.players[playerIndex]) {
                            this.gameData.players[playerIndex].position = toPosition;
                        }
                        
                        // Clear destination highlighting
                        if (destinationSquare) {
                            destinationSquare.style.boxShadow = '';
                            destinationSquare.style.border = '';
                            destinationSquare.style.transform = '';
                            destinationSquare.style.zIndex = '';
                        }
                        
                        // Remove moving animation
                        piece.classList.remove('moving');
                        
                        // Handle special spaces after movement completes
                        setTimeout(() => {
                            this.handleSpecialSpace(playerIndex, toPosition);
                            this.updateGameControls();
                            this.updatePlayersDisplay(this.gameData.players);
                        }, 500);
                        
                        return;
                    }

                    // Calculate next position (anticlockwise around board)
                    currentPosition = (currentPosition - 1 + 40) % 40;
                    stepsRemaining--;

                    console.log(`Moving backward to position ${currentPosition}, ${stepsRemaining} steps remaining`);

                    // Move piece to new position
                    const newProperty = document.querySelector(`[data-index="${currentPosition}"]`);
                    if (newProperty) {
                        // Remove piece from current location
                        piece.remove();
                        
                        // Add to new location
                        newProperty.appendChild(piece);
                        
                        // Reset positioning
                        piece.style.left = '50%';
                        piece.style.top = '50%';
                        piece.style.transform = 'translate(-50%, -50%)';
                        
                        // Add moving animation
                        piece.classList.add('moving');
                        soundManager.play('playerMove');
                        
                        // Continue to next step after delay
                        setTimeout(() => {
                            moveOneStepBackward();
                        }, 600);
                    } else {
                        console.error(`Could not find property element for position ${currentPosition}`);
                        setTimeout(moveOneStepBackward, 600);
                    }
                };

                // UI Update Methods
            updatePlayersDisplay(players) {
                const playersList = document.getElementById('players-list');
                playersList.innerHTML = '';
                
                players.forEach((player, index) => {
                    const playerItem = document.createElement('div');
                    playerItem.className = `player-item ${this.gameData && this.gameData.currentPlayer === index ? 'current' : ''}`;
                    
                    const achievements = learningAnalytics.data.achievements.slice(0, 3).map(id => 
                        `<div class="achievement-badge" title="${id}">🏆</div>`
                    ).join('');
                    
                    playerItem.innerHTML = `
                        <div>
                            <div style="font-weight: bold;">${player.name} ${player.isHost ? '👑' : ''}</div>
                            <div style="font-size: calc(10px * var(--scale)); color: #666;">${player.properties.length} properties</div>
                            <div class="player-achievements">${achievements}</div>
                        </div>
                        <div class="player-money">£${player.money}</div>
                    `;
                    playersList.appendChild(playerItem);
                });
            }

            updatePlayerPieces() {
                document.querySelectorAll('.player-piece').forEach(piece => piece.remove());
                
                if (!this.gameData || !this.gameData.players) return;
                
                this.gameData.players.forEach((player, index) => {
                    const piece = document.createElement('div');
                    piece.className = `player-piece player-piece-${index}`;
                    piece.textContent = player.name.charAt(0).toUpperCase();
                    piece.title = `${player.name} - £${player.money}`;
                    piece.id = `player-${index}`;
                    
                    const position = player.position || 0;
                    const property = document.querySelector(`[data-index="${position}"]`);
                    
                    if (property) {
                        property.appendChild(piece);
                        
                        const existingPieces = property.querySelectorAll('.player-piece').length;
                        if (existingPieces > 1) {
                            const angle = (existingPieces - 1) * (360 / this.gameData.players.length);
                            const radius = 12 * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--scale'));
                            const x = Math.cos(angle * Math.PI / 180) * radius;
                            const y = Math.sin(angle * Math.PI / 180) * radius;
                            piece.style.left = `calc(50% + ${x}px)`;
                            piece.style.top = `calc(50% + ${y}px)`;
                        }
                    }
                });
            }

            updateTurnIndicator() {
                const indicator = document.getElementById('turn-indicator');
                if (!this.gameData || !this.gameData.gameStarted) {
                    indicator.textContent = 'Waiting to start...';
                    indicator.style.background = '#6c757d';
                    return;
                }
                
                const currentPlayerData = this.gameData.players[this.gameData.currentPlayer];
                const isMyTurn = currentPlayerData && currentPlayerData.name === this.currentPlayer;
                
                indicator.textContent = isMyTurn ? 'Your Turn' : `${currentPlayerData.name}'s Turn`;
                indicator.style.background = isMyTurn ? '#ff6b6b' : '#4CAF50';
                
                if (isMyTurn) {
                    indicator.style.animation = 'pulse 2s infinite';
                } else {
                    indicator.style.animation = 'none';
                }
            }

            updateGameControls() {
                const isMyTurn = this.gameData && this.gameData.players[this.gameData.currentPlayer]?.name === this.currentPlayer;
                const gamePhase = this.gameData?.gamePhase || 'question';
                const waitingForAnswer = this.gameData?.waitingForAnswer || false;
                
                document.querySelectorAll('#center-game-controls .btn').forEach(btn => btn.classList.add('hidden'));
                
                if (!isMyTurn || !this.gameData?.gameStarted) return;
                
                if (gamePhase === 'question' && !waitingForAnswer) {
                    document.getElementById('start-turn-btn').classList.remove('hidden');
                } else if (gamePhase === 'dice') {
                    document.getElementById('roll-dice-btn').classList.remove('hidden');
                    document.getElementById('center-dice-result').classList.add('hidden');
                } else if (gamePhase === 'property' && this.canBuyProperty) {
                    // Don't show buy button here - the modal handles it
                    document.getElementById('end-turn-btn').classList.remove('hidden');
                } else if (gamePhase === 'endTurn') {
                    document.getElementById('end-turn-btn').classList.remove('hidden');
                }

                // Always show development button when it's the player's turn (except during questions)
                if (isMyTurn && gamePhase !== 'question') {
                    document.getElementById('develop-property-btn').classList.remove('hidden');
                }
            }

            updatePropertiesDisplay() {
                if (!this.gameData || !this.currentPlayer) return;
                
                const player = this.gameData.players.find(p => p.name === this.currentPlayer);
                if (!player) return;
                
                const propertiesList = document.getElementById('properties-list');
                if (player.properties.length === 0) {
                    propertiesList.innerHTML = 'No properties owned';
                    return;
                }
                
                // Group properties by color/type
                const propertyGroups = {
                    'dark-purple': [],
                    'light-blue': [],
                    'purple': [],
                    'orange': [],
                    'red': [],
                    'yellow': [],
                    'green': [],
                    'dark-blue': [],
                    'railroad': [],
                    'utility': []
                };

                const colorNames = {
                    'dark-purple': 'Brown Properties',
                    'light-blue': 'Light Blue Properties',
                    'purple': 'Pink Properties',
                    'orange': 'Orange Properties',
                    'red': 'Red Properties',
                    'yellow': 'Yellow Properties',
                    'green': 'Green Properties',
                    'dark-blue': 'Dark Blue Properties',
                    'railroad': 'Railroads',
                    'utility': 'Utilities'
                };
                
                player.properties.forEach(propIndex => {
                    const property = propertyManager.getProperty(propIndex);
                    if (property) {
                        const group = property.color || property.type || 'other';
                        if (propertyGroups[group]) {
                            propertyGroups[group].push({ index: propIndex, ...property });
                        }
                    }
                });
                
                let html = '';
                Object.entries(propertyGroups).forEach(([colorGroup, properties]) => {
                    if (properties.length > 0) {
                        html += `<div class="property-group">`;
                        html += `<div class="property-group-title">${colorNames[colorGroup]} (${properties.length})</div>`;
                        
                        properties.forEach(property => {
                            const developable = propertyManager.canDevelop(this.gameData.currentPlayer, property.index);
                            const developmentInfo = property.houses > 0 ? 
                                `<div class="property-details">Development: ${property.houses === 5 ? 'Hotel' : property.houses + ' Houses'}</div>` : '';
                            const canDevelopInfo = developable ? 
                                '<div class="property-details" style="color: #28a745;">Can develop!</div>' : '';
                            
                            html += `
                                <div class="property-list-item ${colorGroup} ${developable ? 'developable' : ''}">
                                    <div class="property-name">${property.name}</div>
                                    ${developmentInfo}
                                    ${canDevelopInfo}
                                </div>
                            `;
                        });
                        html += `</div>`;
                    }
                });
                
                propertiesList.innerHTML = html;
            }

            updateCardsDisplay() {
                if (!this.gameData || !this.currentPlayer) return;
                
                const player = this.gameData.players.find(p => p.name === this.currentPlayer);
                if (!player) return;
                
                const cardsList = document.getElementById('cards-list');
                if (!player.cards || player.cards.length === 0) {
                    cardsList.innerHTML = 'No cards held';
                    return;
                }
                
                cardsList.innerHTML = player.cards.map(card => {
                    const cardType = card.type.includes('Jail') ? 'chance' : 'community';
                    return `<div class="card-item ${cardType}">${card.text}</div>`;
                }).join('');
            }

            showQuestion(question, isBonus = false) {
                console.log('showQuestion called with:', { question, isBonus });
                
                if (!question || !question.question || !question.options) {
                    console.error('Invalid question object:', question);
                    return;
                }
                
                const modal = document.getElementById('question-modal');
                const questionTitle = document.getElementById('question-title');
                const questionText = document.getElementById('question-text');
                const questionOptions = document.getElementById('question-options');
                const timerValue = document.getElementById('timer-value');
                const difficultyIndicator = document.getElementById('difficulty-indicator');
                
                modal.classList.remove('hidden');
                
                const questionContent = document.querySelector('.question-content');
                if (questionContent) {
                    questionContent.className = 'question-content';
                }
                
                // Show difficulty level
                const difficulty = learningAnalytics.getDifficulty();
                difficultyIndicator.textContent = `${difficulty.toUpperCase()} LEVEL`;
                difficultyIndicator.className = `difficulty-indicator difficulty-${difficulty}`;
                difficultyIndicator.classList.remove('hidden');
                
                if (isBonus) {
                    if (question.cardType === 'chance') {
                        questionContent.classList.add('bonus-chance');
                    } else {
                        questionContent.classList.add('bonus-community');
                    }
                    
                    const title = question.cardType === 'chance' ? '❓ Chance Bonus Question' : '📦 Community Chest Bonus Question';
                    questionTitle.textContent = title;
                    
                    const existingReward = document.getElementById('bonus-reward');
                    if (existingReward) existingReward.remove();
                    
                    const rewardDiv = document.createElement('div');
                    rewardDiv.id = 'bonus-reward';
                    rewardDiv.className = 'bonus-reward';
                    rewardDiv.textContent = '💰 Answer correctly to win £200!';
                    
                    questionText.parentNode.insertBefore(rewardDiv, questionText);
                } else {
                    questionTitle.textContent = '📚 Business Question';
                    
                    const existingReward = document.getElementById('bonus-reward');
                    if (existingReward) existingReward.remove();
                }
                
                questionText.textContent = question.question;
                questionOptions.innerHTML = '';
                
                question.options.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'question-option';
                    optionDiv.textContent = option;
                    optionDiv.onclick = () => {
                        if (isBonus) {
                            this.answerBonusQuestion(index, question.cardType);
                        } else {
                            this.answerQuestion(index);
                        }
                    };
                    questionOptions.appendChild(optionDiv);
                });
                
                // Start timer
                let timeLeft = question.timeLimit || 30;
                if (timerValue) {
                    timerValue.textContent = timeLeft;
                    
                    const timerInterval = setInterval(() => {
                        timeLeft--;
                        if (timerValue) {
                            timerValue.textContent = timeLeft;
                        }
                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);
                        }
                    }, 1000);
                }
            }

            answerQuestion(answerIndex) {
                this.socket.emit('answerQuestion', { roomCode: this.currentRoom, answerIndex });
            }

            answerBonusQuestion(answerIndex, cardType) {
                this.socket.emit('answerBonusQuestion', { 
                    roomCode: this.currentRoom, 
                    answerIndex, 
                    cardType 
                });
            }

            hideQuestion() {
                document.getElementById('question-modal').classList.add('hidden');
            }

            showCardModal(title, text, cardType, actionText = "Card effect will be applied automatically...") {
                const modal = document.getElementById('card-modal');
                const content = document.getElementById('card-content');
                
                modal.classList.remove('hidden');
                document.getElementById('card-title').textContent = title;
                document.getElementById('card-text').textContent = text;
                document.getElementById('card-action-text').textContent = actionText;
                
                content.className = `card-content ${cardType}`;
                
                setTimeout(() => {
                    this.hideCardModal();
                }, 4000);
            }

            hideCardModal() {
                document.getElementById('card-modal').classList.add('hidden');
            }

            showMessage(text, type = 'success') {
                const messageDiv = document.createElement('div');
                const bgColor = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1';
                const textColor = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460';
                const borderColor = type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#bee5eb';
                
                messageDiv.style.cssText = `
                    position: fixed; top: 16px; right: 16px; 
                    background: ${bgColor}; color: ${textColor};
                    padding: calc(12px * var(--scale)); border-radius: calc(8px * var(--scale)); 
                    max-width: calc(235px * var(--scale)); z-index: 1001;
                    border: calc(2px * var(--scale)) solid ${borderColor};
                    font-size: calc(11px * var(--scale)); text-transform: none;
                    box-shadow: 0 calc(3px * var(--scale)) calc(9px * var(--scale)) rgba(0,0,0,0.2);
                `;
                messageDiv.textContent = text;
                document.body.appendChild(messageDiv);
                
                setTimeout(() => messageDiv.remove(), 5000);
            }
        }

        // ====== GLOBAL FUNCTIONS ======

        function showPropertyInfo(propertyIndex) {
            const property = propertyManager.getProperty(propertyIndex);
            if (!property) return;

            const modal = document.getElementById('property-modal');
            const title = document.getElementById('property-title');
            const details = document.getElementById('property-details');

            title.textContent = property.name;
            
            let rentStructure = '';
            if (property.type === 'railroad') {
                rentStructure = `
                    <div class="rent-structure">
                        <h4>Railroad Rent:</h4>
                        <div class="rent-item"><span>1 Railroad owned:</span><span>£${property.rent[0]}</span></div>
                        <div class="rent-item"><span>2 Railroads owned:</span><span>£${property.rent[1]}</span></div>
                        <div class="rent-item"><span>3 Railroads owned:</span><span>£${property.rent[2]}</span></div>
                        <div class="rent-item"><span>4 Railroads owned:</span><span>£${property.rent[3]}</span></div>
                    </div>
                `;
            } else if (property.type === 'utility') {
                rentStructure = `
                    <div class="rent-structure">
                        <h4>Utility Rent:</h4>
                        <div class="rent-item"><span>1 Utility owned:</span><span>4x dice roll</span></div>
                        <div class="rent-item"><span>2 Utilities owned:</span><span>10x dice roll</span></div>
                    </div>
                `;
            } else if (property.rent) {
                rentStructure = `
                    <div class="rent-structure">
                        <h4>Rent Structure:</h4>
                        <div class="rent-item"><span>Base rent:</span><span>£${property.rent[0]}</span></div>
                        <div class="rent-item"><span>With 1 house:</span><span>£${property.rent[1]}</span></div>
                        <div class="rent-item"><span>With 2 houses:</span><span>£${property.rent[2]}</span></div>
                        <div class="rent-item"><span>With 3 houses:</span><span>£${property.rent[3]}</span></div>
                        <div class="rent-item"><span>With 4 houses:</span><span>£${property.rent[4]}</span></div>
                        <div class="rent-item"><span>With hotel:</span><span>£${property.rent[5]}</span></div>
                    </div>
                `;
            }

            const ownership = property.owner !== null ? 
                `<p><strong>Owner:</strong> Player ${property.owner + 1}</p>` : 
                `<p><strong>Status:</strong> Available for purchase</p>`;

            details.innerHTML = `
                <p><strong>Purchase Price:</strong> £${property.price}</p>
                ${ownership}
                ${property.houses > 0 ? `<p><strong>Development:</strong> ${property.houses === 5 ? 'Hotel' : property.houses + ' houses'}</p>` : ''}
                ${rentStructure}
            `;

            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function hidePropertyModal() {
            const modal = document.getElementById('property-modal');
            modal.classList.remove('show');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function confirmPurchaseProperty() {
            gameController.buyProperty();
            gameController.hidePropertyPurchaseModal();
        }

        function declineProperty() {
            gameController.hidePropertyPurchaseModal();
            gameController.showMessage('Property purchase declined', 'info');
        }

        // Accessibility Functions
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const btn = document.querySelector('.accessibility-controls .accessibility-btn');
            btn.classList.toggle('active');
        }

        function toggleHighContrast() {
            document.body.classList.toggle('high-contrast');
            event.target.classList.toggle('active');
        }

        function adjustFontSize() {
            const currentSize = parseInt(getComputedStyle(document.body).fontSize);
            const newSize = currentSize >= 14 ? 10 : currentSize + 1;
            document.body.style.fontSize = newSize + 'px';
        }

        function toggleSound() {
            const muted = soundManager.toggleMute();
            const btn = document.querySelector('.sound-btn');
            btn.textContent = muted ? '🔇' : '🔊';
            btn.classList.toggle('muted', muted);
        }

    // ====== INITIALIZATION ======

        // Declare global instances
        let soundManager, learningAnalytics, propertyManager, gameController;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize global instances
            soundManager = new SoundManager();
            learningAnalytics = new LearningAnalytics();
            propertyManager = new PropertyManager();
            gameController = new GameController();

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Setup keyboard listeners
            document.getElementById('playerName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    gameController.createRoom();
                }
            });

            document.getElementById('roomCode').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    gameController.joinRoom();
                }
            });

            // Initialize learning analytics display
            learningAnalytics.updateDisplay();

            console.log('🎮 Game initialized successfully!');
        });
    </script>
</body>
</html>
